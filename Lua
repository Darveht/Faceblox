

-- Server: FaceBlox (pegar en ServerScriptService)
-- CAMBIOS IMPORTANTES:
-- 1) Aseguro que el admin siempre tenga followersCount sincronizado (getAdminData aplicado globalmente).
-- 2) Cuando se cargan allUsers, admin usa follower count especial.
-- 3) Cuando se actualizan follows, si objetivo es admin el displayed followers usa el valor admin especial.
-- 4) Proporciono endpoints RemoteFunction/RemoteEvent tal como tu cliente espera.

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local DataStoreService = game:GetService("DataStoreService")
local HttpService = game:GetService("HttpService")

local PlayerDataStore   = DataStoreService:GetDataStore("PlayerData")
local PostsDataStore    = DataStoreService:GetDataStore("Posts")
local PostsIndexStore   = DataStoreService:GetDataStore("PostsIndex")
local CommentsDataStore = DataStoreService:GetDataStore("Comments")
local UsersDataStore    = DataStoreService:GetDataStore("AllUsers")
local ReportsDataStore  = DataStoreService:GetDataStore("Reports")

local function getOrCreate(parent, className, name)
    local existing = parent:FindFirstChild(name)
    if existing then return existing end
    local inst = Instance.new(className)
    inst.Name = name
    inst.Parent = parent
    return inst
end

local remoteEventsFolder = ReplicatedStorage:FindFirstChild("RemoteEvents")
if not remoteEventsFolder then
    remoteEventsFolder = Instance.new("Folder", ReplicatedStorage)
    remoteEventsFolder.Name = "RemoteEvents"
end

-- Cliente -> servidor
local createPostEvent    = getOrCreate(remoteEventsFolder, "RemoteEvent", "CreatePost")
local likePostEvent      = getOrCreate(remoteEventsFolder, "RemoteEvent", "LikePost")
local commentPostEvent   = getOrCreate(remoteEventsFolder, "RemoteEvent", "CommentPost")
local followUserEvent    = getOrCreate(remoteEventsFolder, "RemoteEvent", "FollowUser")
local hideCommentEvent   = getOrCreate(remoteEventsFolder, "RemoteEvent", "HideComment")
local reportUserEvent    = getOrCreate(remoteEventsFolder, "RemoteEvent", "ReportUser")
local deleteCommentEvent = getOrCreate(remoteEventsFolder, "RemoteEvent", "DeleteComment")

-- Servidor -> cliente
local postCreatedEvent   = getOrCreate(remoteEventsFolder, "RemoteEvent", "PostCreated")
local postUpdatedEvent   = getOrCreate(remoteEventsFolder, "RemoteEvent", "PostUpdated")
local commentAddedEvent  = getOrCreate(remoteEventsFolder, "RemoteEvent", "CommentAdded")
local commentDeletedEvent= getOrCreate(remoteEventsFolder, "RemoteEvent", "CommentDeleted")
local followUpdatedEvent = getOrCreate(remoteEventsFolder, "RemoteEvent", "FollowUpdated")
local linkProfileEvent   = getOrCreate(remoteEventsFolder, "RemoteEvent", "LinkProfile")
local searchResultsEvent = getOrCreate(remoteEventsFolder, "RemoteEvent", "SearchResults")

-- RemoteFunctions
local getFeedFunction         = getOrCreate(remoteEventsFolder, "RemoteFunction", "GetFeed")
local getProfileFunction      = getOrCreate(remoteEventsFolder, "RemoteFunction", "GetProfile")
local searchUsersFunction     = getOrCreate(remoteEventsFolder, "RemoteFunction", "SearchUsers")
local getCommentsFunction     = getOrCreate(remoteEventsFolder, "RemoteFunction", "GetComments")
local getUserPostsFunction    = getOrCreate(remoteEventsFolder, "RemoteFunction", "GetUserPosts")
local getRecommendationsFn    = getOrCreate(remoteEventsFolder, "RemoteFunction", "GetRecommendations")
local getAdminReportsFunction = getOrCreate(remoteEventsFolder, "RemoteFunction", "GetAdminReports")
local getPlayerAvatarFunction = getOrCreate(remoteEventsFolder, "RemoteFunction", "GetPlayerAvatar")

-- Memoria
local playerData = {}
local allUsers = {}
local postsIndex = {}
local pendingReports = {}

-- Admins (siempre 'vegetl_t' en tu ejemplo)
local admins = {
{username = "vegetl_t", displayName = "darheel"}
}

local function isAdmin(username, displayName)
    for _, admin in pairs(admins) do
        if string.lower(username or "") == string.lower(admin.username)
            or (displayName and string.lower(displayName) == string.lower(admin.displayName)) then
            return true
        end
    end
    return false
end

local function getAdminData()
    return {
    followersCount = 222000,
    isVerified = true,
    isAdmin = true,
    displayName = "vegetl_t",
    username = "vegetl_t"
    }
end

local function isVerified(username, displayName, followersCount)
    local lowerUsername = string.lower(username or "")
    local lowerDisplayName = string.lower(displayName or "")
    if lowerUsername == "vegetl_t" or lowerDisplayName == "vegetl_t" then
        return true
    end
    return (followersCount or 0) >= 1000
end

-- DataStore helpers con retries
local function saveDataStore(dataStore, key, value)
    local success, result
    local attempts = 0
    repeat
    success, result = pcall(function() return dataStore:SetAsync(key, value) end)
        if not success then
            warn("DataStore SetAsync fallo para key="..tostring(key)..": "..tostring(result)..". Reintentando...")
            wait(2 ^ math.min(attempts, 6))
            attempts = attempts + 1
        end
        until success or attempts > 5
        return success
    end
    
    local function getDataStore(dataStore, key)
        local success, result
        local attempts = 0
        repeat
        success, result = pcall(function() return dataStore:GetAsync(key) end)
            if not success then
                warn("DataStore GetAsync fallo para key="..tostring(key)..": "..tostring(result)..". Reintentando...")
                wait(2 ^ math.min(attempts, 6))
                attempts = attempts + 1
            end
            until success or attempts > 5
            if success then return result else return nil end
        end
        
        local function generateUniqueId()
            return HttpService:GenerateGUID(false)
        end
        
        -- Save/load helpers
        local function savePlayerData(player)
            if playerData[player.UserId] then
                saveDataStore(PlayerDataStore, tostring(player.UserId), playerData[player.UserId])
            end
        end
        
        local function saveAllUsersData()
            saveDataStore(UsersDataStore, "AllUsersData", allUsers)
        end
        
        local function loadAllUsersData()
            local data = getDataStore(UsersDataStore, "AllUsersData")
            if data then
                allUsers = data
            else
                allUsers = {}
            end
            
            -- asegurar que la entrada admin (si existe por username) tenga followersCount especial
            for k, v in pairs(allUsers) do
                if v.username and string.lower(v.username) == "vegetl_t" then
                    local adminData = getAdminData()
                    allUsers[k].followersCount = adminData.followersCount
                    allUsers[k].isVerified = true
                    allUsers[k].isAdmin = true
                end
            end
        end
        
        local function loadPostsIndex()
            local idx = getDataStore(PostsIndexStore, "AllPosts")
            if idx and type(idx) == "table" then postsIndex = idx else postsIndex = {} end
        end
        
        local function loadPlayerData(player)
            local key = tostring(player.UserId)
            local data = getDataStore(PlayerDataStore, key)
            if data then
                playerData[player.UserId] = data
            else
                playerData[player.UserId] = {
                displayName = player.DisplayName,
                followers = {},
                following = {},
                posts = {},
                profilePicture = "rbxasset://textures/face.png",
                bio = "¡Nuevo en FaceBlox!",
                joinDate = os.time(),
                isAdmin = isAdmin(player.Name, player.DisplayName)
                }
                savePlayerData(player)
            end
            
            -- actualizar allUsers y sincronizar admin si corresponde
            allUsers[key] = allUsers[key] or {}
            allUsers[key].userId = player.UserId
            allUsers[key].displayName = player.DisplayName
            allUsers[key].username = player.Name
            allUsers[key].lastSeen = os.time()
            allUsers[key].isAdmin = isAdmin(player.Name, player.DisplayName)
            
            local followersCount = 0
            if playerData[player.UserId].followers then
                for _ in pairs(playerData[player.UserId].followers) do followersCount = followersCount + 1 end
            end
            
            -- si este usuario es el admin por username, forzamos followersCount (sincronización global)
            if string.lower(player.Name or "") == "vegetl_t" then
                local adminData = getAdminData()
                followersCount = adminData.followersCount
                allUsers[key].isVerified = true
                allUsers[key].isAdmin = true
            else
                allUsers[key].isVerified = isVerified(player.Name, player.DisplayName, followersCount)
            end
            
            allUsers[key].followersCount = followersCount
        end
        
        -- ---------- FUNCIONES PRINCIPALES ----------
        local function createPost(player, content, imageId, musicId)
            local postId = generateUniqueId()
            local followersCount = 0
            if playerData[player.UserId] and playerData[player.UserId].followers then
                for _ in pairs(playerData[player.UserId].followers) do followersCount = followersCount + 1 end
            end
            
            local avatar = (playerData[player.UserId] and playerData[player.UserId].profilePicture) or ("https://www.roblox.com/headshot-thumbnail/image?userId="..player.UserId.."&width=150&height=150&format=png")
            
            local newPost = {
            id = postId,
            authorId = player.UserId,
            authorName = player.DisplayName,
            authorUsername = player.Name,
            profilePicture = avatar,
            content = content or "",
            imageId = imageId or "",
            musicId = musicId or "",
            timestamp = os.time(),
            likes = {},
            comments = {},
            isVerified = isVerified(player.Name, player.DisplayName, followersCount)
            }
            
            local success = saveDataStore(PostsDataStore, postId, newPost)
            if not success then return false, "Error guardando post" end
            
            playerData[player.UserId].posts = playerData[player.UserId].posts or {}
            table.insert(playerData[player.UserId].posts, 1, postId)
            savePlayerData(player)
            
            postsIndex = postsIndex or {}
            table.insert(postsIndex, 1, postId)
            local MAX_INDEX = 500
            while #postsIndex > MAX_INDEX do table.remove(postsIndex, #postsIndex) end
            saveDataStore(PostsIndexStore, "AllPosts", postsIndex)
            
            pcall(function() postCreatedEvent:FireAllClients(newPost) end)
                return true, postId
            end
            
            local function likePost(player, postId)
                local post = getDataStore(PostsDataStore, postId)
                if not post then return false, "Post no encontrado" end
                
                local userIdStr = tostring(player.UserId)
                post.likes = post.likes or {}
                local isLiked = post.likes[userIdStr] ~= nil
                
                if isLiked then post.likes[userIdStr] = nil
                else post.likes[userIdStr] = { userId = player.UserId, displayName = player.DisplayName, timestamp = os.time() } end
                    
                    local success = saveDataStore(PostsDataStore, postId, post)
                    if not success then return false, "Error actualizando like" end
                    
                    local likesCount = 0
                    for _ in pairs(post.likes or {}) do likesCount = likesCount + 1 end
                    local commentsCount = #(post.comments or {})
                    pcall(function() postUpdatedEvent:FireAllClients(postId, likesCount, commentsCount) end)
                        return true, not isLiked
                    end
                    
                    local function commentOnPost(player, postId, content)
                        local post = getDataStore(PostsDataStore, postId)
                        if not post then return false, "Post no encontrado" end
                        
                        local commentId = generateUniqueId()
                        local followersCount = 0
                        if playerData[player.UserId] and playerData[player.UserId].followers then
                            for _ in pairs(playerData[player.UserId].followers) do followersCount = followersCount + 1 end
                        end
                        
                        local newComment = {
                        id = commentId,
                        postId = postId,
                        authorId = player.UserId,
                        authorName = player.DisplayName,
                        authorUsername = player.Name,
                        content = content,
                        timestamp = os.time(),
                        isVerified = isVerified(player.Name, player.DisplayName, followersCount)
                        }
                        
                        local successComment = saveDataStore(CommentsDataStore, commentId, newComment)
                        if not successComment then return false, "Error guardando comentario" end
                        
                        post.comments = post.comments or {}
                        table.insert(post.comments, commentId)
                        local successPost = saveDataStore(PostsDataStore, postId, post)
                        if not successPost then return false, "Error actualizando post con comentario" end
                        
                        pcall(function() commentAddedEvent:FireAllClients(postId, newComment) end)
                            local likesCount = 0
                            for _ in pairs(post.likes or {}) do likesCount = likesCount + 1 end
                            pcall(function() postUpdatedEvent:FireAllClients(postId, likesCount, #post.comments) end)
                                
                                return true, newComment
                            end
                            
                            local function followUser(player, targetUserId)
                                local targetUserData = getDataStore(PlayerDataStore, tostring(targetUserId))
                                if not targetUserData then return false, "Usuario no encontrado" end
                                local followerData = playerData[player.UserId]
                                if not followerData then return false, "Datos de jugador no cargados" end
                                
                                local followerIdStr = tostring(player.UserId)
                                local targetUserIdStr = tostring(targetUserId)
                                
                                followerData.following = followerData.following or {}
                                targetUserData.followers = targetUserData.followers or {}
                                
                                local isFollowing = followerData.following[targetUserIdStr] ~= nil
                                
                                if isFollowing then
                                    followerData.following[targetUserIdStr] = nil
                                    targetUserData.followers[followerIdStr] = nil
                                else
                                    followerData.following[targetUserIdStr] = { userId = targetUserId, timestamp = os.time() }
                                    targetUserData.followers[followerIdStr] = { userId = player.UserId, displayName = player.DisplayName, timestamp = os.time() }
                                end
                                
                                local success1 = saveDataStore(PlayerDataStore, followerIdStr, followerData)
                                local success2 = saveDataStore(PlayerDataStore, targetUserIdStr, targetUserData)
                                
                                if success1 and success2 then
                                    -- actualizar allUsers (y sincronizar admin)
                                    loadAllUsersData()
                                    if allUsers[targetUserIdStr] then
                                        -- si el target es admin por username, forzamos el admin follower count especial
                                        if string.lower(allUsers[targetUserIdStr].username or "") == "vegetl_t" then
                                            local adminData = getAdminData()
                                            allUsers[targetUserIdStr].followersCount = adminData.followersCount
                                            allUsers[targetUserIdStr].isVerified = true
                                            allUsers[targetUserIdStr].isAdmin = true
                                        else
                                            local newFollowersCount = 0
                                            for _ in pairs(targetUserData.followers or {}) do newFollowersCount = newFollowersCount + 1 end
                                            allUsers[targetUserIdStr].followersCount = newFollowersCount
                                            allUsers[targetUserIdStr].isVerified = isVerified(allUsers[targetUserIdStr].username, allUsers[targetUserIdStr].displayName, newFollowersCount)
                                        end
                                        saveAllUsersData()
                                    end
                                    
                                    pcall(function() followUpdatedEvent:FireAllClients(player.UserId, targetUserId, not isFollowing) end)
                                        return true, not isFollowing
                                    end
                                    return false, "Error al seguir/dejar de seguir"
                                end
                                
                                local function searchUsers(player, query)
                                    loadAllUsersData()
                                    local results = {}
                                    local queryLower = string.lower(query or "")
                                    
                                    for userId, userData in pairs(allUsers) do
                                        if userData.displayName and userData.username then
                                            local dn = string.lower(userData.displayName)
                                            local un = string.lower(userData.username)
                                            if string.find(dn, queryLower) or string.find(un, queryLower) then
                                                local fullUserData = getDataStore(PlayerDataStore, userId)
                                                if fullUserData then
                                                    local followersCount = fullUserData.followers and (function()
                                                        local c=0; for _ in pairs(fullUserData.followers) do c=c+1 end; return c
                                                    end)() or 0
                                                    
                                                    -- Si el usuario es admin por username, forzamos valor admin
                                                    if string.lower(userData.username or "") == "vegetl_t" then
                                                        local adminData = getAdminData()
                                                        followersCount = adminData.followersCount
                                                    end
                                                    
                                                    table.insert(results, {
                                                    userId = userData.userId,
                                                    displayName = userData.displayName,
                                                    username = userData.username,
                                                    followersCount = followersCount,
                                                    isVerified = (string.lower(userData.username or "") == "vegetl_t") or isVerified(userData.username, userData.displayName, followersCount),
                                                    profilePicture = fullUserData.profilePicture or "rbxasset://textures/face.png"
                                                    })
                                                end
                                            end
                                        end
                                    end
                                    
                                    pcall(function() searchResultsEvent:FireClient(player, results) end)
                                        return results
                                    end
                                    
                                    local function getFeed(player)
                                        loadAllUsersData()
                                        loadPostsIndex()
                                        
                                        local feedPosts = {}
                                        local MAX_RETURN = 100
                                        local count = 0
                                        
                                        for i, postId in ipairs(postsIndex or {}) do
                                            if count >= MAX_RETURN then break end
                                            local postData = getDataStore(PostsDataStore, postId)
                                            if postData then
                                                local post = table.clone(postData)
                                                post.profilePicture = post.profilePicture or post.authorProfilePicture or ("https://www.roblox.com/headshot-thumbnail/image?userId="..tostring(post.authorId).."&width=150&height=150&format=png")
                                                post.likesCount = 0
                                                for _ in pairs(post.likes or {}) do post.likesCount = post.likesCount + 1 end
                                                post.commentsCount = #(post.comments or {})
                                                post.isLikedByUser = (post.likes and post.likes[tostring(player.UserId)] ~= nil) or false
                                                
                                                -- si el author es admin por username, forzar isVerified + followersCount fuente admin (cliente no recibe followersCount en post, pero isVerified es importante)
                                                if string.lower(post.authorUsername or "") == "vegetl_t" then
                                                    post.isVerified = true
                                                end
                                                
                                                table.insert(feedPosts, post)
                                                count = count + 1
                                            end
                                        end
                                        
                                        table.sort(feedPosts, function(a,b) return (a.timestamp or 0) > (b.timestamp or 0) end)
                                            return feedPosts
                                        end
                                        
                                        local function getUserPosts(userId)
                                            local userData = getDataStore(PlayerDataStore, tostring(userId))
                                            if not userData then return {} end
                                            
                                            local userPosts = {}
                                            for _, postId in ipairs(userData.posts or {}) do
                                                local postData = getDataStore(PostsDataStore, postId)
                                                if postData then
                                                    local post = table.clone(postData)
                                                    post.profilePicture = post.profilePicture or post.authorProfilePicture
                                                    post.likesCount = 0
                                                    for _ in pairs(post.likes or {}) do post.likesCount = post.likesCount + 1 end
                                                    post.commentsCount = #(post.comments or {})
                                                    if string.lower(post.authorUsername or "") == "vegetl_t" then post.isVerified = true end
                                                    table.insert(userPosts, post)
                                                end
                                            end
                                            
                                            table.sort(userPosts, function(a, b) return a.timestamp > b.timestamp end)
                                                return userPosts
                                            end
                                            
                                            local function getPostComments(postId)
                                                local post = getDataStore(PostsDataStore, postId)
                                                if not post then return {} end
                                                
                                                local postComments = {}
                                                for _, commentId in ipairs(post.comments or {}) do
                                                    local comment = getDataStore(CommentsDataStore, commentId)
                                                    if comment and not comment.deleted then
                                                        -- si el autor es admin forzamos isVerified
                                                        if string.lower(comment.authorUsername or "") == "vegetl_t" then
                                                            comment.isVerified = true
                                                        end
                                                        table.insert(postComments, comment)
                                                    end
                                                end
                                                
                                                table.sort(postComments, function(a,b) return a.timestamp < b.timestamp end)
                                                    return postComments
                                                end
                                                
                                                local function getProfile(player, targetUserId)
                                                    targetUserId = targetUserId or player.UserId
                                                    local targetUserData = getDataStore(PlayerDataStore, tostring(targetUserId))
                                                    if not targetUserData then return nil, "Usuario no encontrado" end
                                                    
                                                    local successName, playerName = pcall(function() return Players:GetNameFromUserIdAsync(tonumber(targetUserId)) end)
                                                        if not successName then playerName = targetUserData.username or ("User"..tostring(targetUserId)) end
                                                        
                                                        local isAdminFlag = false
                                                        if playerName then
                                                            isAdminFlag = (string.lower(playerName) == "vegetl_t") or (targetUserData.username and string.lower(targetUserData.username) == "vegetl_t")
                                                        end
                                                        
                                                        -- compute followersCount (respetando admin override)
                                                        local followersCount = 0
                                                        if isAdminFlag then
                                                            local adminData = getAdminData()
                                                            followersCount = adminData.followersCount
                                                        else
                                                            if targetUserData.followers then
                                                                for _ in pairs(targetUserData.followers) do followersCount = followersCount + 1 end
                                                            end
                                                        end
                                                        
                                                        local followingCount = 0
                                                        if targetUserData.following then
                                                            for _ in pairs(targetUserData.following) do followingCount = followingCount + 1 end
                                                        end
                                                        
                                                        -- refrescar allUsers entry si existe
                                                        loadAllUsersData()
                                                        if allUsers[tostring(targetUserId)] then
                                                            allUsers[tostring(targetUserId)].followersCount = followersCount
                                                            allUsers[tostring(targetUserId)].isVerified = isAdminFlag or isVerified(targetUserData.username or "", targetUserData.displayName, followersCount)
                                                            saveAllUsersData()
                                                        end
                                                        
                                                        local profile = {
                                                        userId = targetUserId,
                                                        displayName = targetUserData.displayName or playerName,
                                                        username = targetUserData.username or playerName,
                                                        bio = targetUserData.bio,
                                                        profilePicture = targetUserData.profilePicture,
                                                        followersCount = followersCount,
                                                        followingCount = followingCount,
                                                        postsCount = #(targetUserData.posts or {}),
                                                        joinDate = targetUserData.joinDate,
                                                        isFollowedByUser = (playerData[player.UserId] and playerData[player.UserId].following[tostring(targetUserId)]) ~= nil,
                                                        isAdmin = isAdminFlag,
                                                        isVerified = isAdminFlag or isVerified(targetUserData.username or "", targetUserData.displayName, followersCount)
                                                        }
                                                        
                                                        return profile
                                                    end
                                                    
                                                    local function getRecommendations(player)
                                                        loadAllUsersData()
                                                        local candidates = {}
                                                        for sid, meta in pairs(allUsers) do
                                                            if meta.userId and meta.userId ~= player.UserId then
                                                                local target = getDataStore(PlayerDataStore, tostring(meta.userId))
                                                                local followerCount = meta.followersCount or 0
                                                                local isAdminUser = string.lower(meta.username or "") == "vegetl_t"
                                                                if isAdminUser then
                                                                    local adminData = getAdminData()
                                                                    followerCount = adminData.followersCount
                                                                end
                                                                table.insert(candidates, {
                                                                userId = meta.userId,
                                                                displayName = meta.displayName or meta.username or "Usuario",
                                                                username = meta.username or "",
                                                                followersCount = followerCount,
                                                                isVerified = isAdminUser or meta.isVerified or isVerified(meta.username or "", meta.displayName or "", followerCount),
                                                                profilePicture = target and target.profilePicture or "rbxasset://textures/face.png"
                                                                })
                                                            end
                                                        end
                                                        
                                                        table.sort(candidates, function(a,b) return a.followersCount > b.followersCount end)
                                                            local out = {}
                                                            local following = (playerData[player.UserId] and playerData[player.UserId].following) or {}
                                                            local followedSet = {}
                                                            for k,_ in pairs(following) do followedSet[k] = true end
                                                            for _, c in ipairs(candidates) do
                                                                if not followedSet[tostring(c.userId)] then
                                                                    table.insert(out, c)
                                                                    if #out >= 20 then break end
                                                                end
                                                            end
                                                            return out
                                                        end
                                                        
                                                        -- ---------- HANDLERS ----------
                                                        createPostEvent.OnServerEvent:Connect(function(player, content, imageId, musicId)
                                                            local success, result = createPost(player, content, imageId, musicId)
                                                            if success then
                                                                print(player.DisplayName .. " creó post: " .. tostring(result))
                                                            else
                                                                warn("Error creando post para " .. player.DisplayName .. ": " .. tostring(result))
                                                            end
                                                        end)
                                                        
                                                        likePostEvent.OnServerEvent:Connect(function(player, postId)
                                                            local success, isLiked = likePost(player, postId)
                                                            if not success then warn("Error like: "..tostring(isLiked)) end
                                                        end)
                                                        
                                                        commentPostEvent.OnServerEvent:Connect(function(player, postId, content)
                                                            local success, commentData = commentOnPost(player, postId, content)
                                                            if not success then warn("Error comentando: "..tostring(commentData)) end
                                                        end)
                                                        
                                                        followUserEvent.OnServerEvent:Connect(function(player, targetUserId)
                                                            local success,_ = followUser(player, targetUserId)
                                                            if not success then warn("Error follow action") end
                                                        end)
                                                        
                                                        hideCommentEvent.OnServerEvent:Connect(function(player, commentId)
                                                            local comment = getDataStore(CommentsDataStore, commentId)
                                                            if comment and tostring(comment.authorId) == tostring(player.UserId) then
                                                                comment.hidden = true
                                                                saveDataStore(CommentsDataStore, commentId, comment)
                                                                hideCommentEvent:FireClient(player, commentId, true)
                                                            end
                                                        end)
                                                        
                                                        reportUserEvent.OnServerEvent:Connect(function(player, targetUserId, reason)
                                                            local reportId = generateUniqueId()
                                                            local reportData = {
                                                            id = reportId,
                                                            reporterId = player.UserId,
                                                            reporterName = player.DisplayName,
                                                            targetUserId = targetUserId,
                                                            reason = reason,
                                                            timestamp = os.time(),
                                                            status = "pending"
                                                            }
                                                            local success = saveDataStore(ReportsDataStore, reportId, reportData)
                                                            if success then
                                                                table.insert(pendingReports, reportData)
                                                                print("Reporte recibido: "..reportId)
                                                            end
                                                        end)
                                                        
                                                        deleteCommentEvent.OnServerEvent:Connect(function(player, commentId)
                                                            local comment = getDataStore(CommentsDataStore, commentId)
                                                            if comment and (tostring(comment.authorId) == tostring(player.UserId) or isAdmin(player.Name, player.DisplayName)) then
                                                                comment.deleted = true
                                                                comment.deletedBy = player.DisplayName
                                                                saveDataStore(CommentsDataStore, commentId, comment)
                                                                pcall(function() commentDeletedEvent:FireAllClients(commentId) end)
                                                                end
                                                                end)
                                                                    
                                                                    linkProfileEvent.OnServerEvent:Connect(function(player)
                                                                        if playerData[player.UserId] then
                                                                            local avatarUrl = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. player.UserId .. "&width=150&height=150&format=png"
                                                                            playerData[player.UserId].profilePicture = avatarUrl
                                                                            savePlayerData(player)
                                                                            linkProfileEvent:FireClient(player, avatarUrl)
                                                                        end
                                                                    end)
                                                                    
                                                                    -- RemoteFunction handlers
                                                                    getFeedFunction.OnServerInvoke = function(player) return getFeed(player) end
                                                                    getProfileFunction.OnServerInvoke = function(player, targetUserId) return getProfile(player, targetUserId) end
                                                                    searchUsersFunction.OnServerInvoke = function(player, query) return searchUsers(player, query) end
                                                                    getCommentsFunction.OnServerInvoke = function(player, postId) return getPostComments(postId) end
                                                                    getUserPostsFunction.OnServerInvoke = function(player, userId) return getUserPosts(userId) end
                                                                    getRecommendationsFn.OnServerInvoke = function(player) return getRecommendations(player) end
                                                                    getAdminReportsFunction.OnServerInvoke = function(player)
                                                                        if isAdmin(player.Name, player.DisplayName) then return pendingReports else return {} end
                                                                    end
                                                                    getPlayerAvatarFunction.OnServerInvoke = function(player)
                                                                        return "https://www.roblox.com/headshot-thumbnail/image?userId=" .. player.UserId .. "&width=150&height=150&format=png"
                                                                    end
                                                                    
                                                                    -- Player lifecycle
                                                                    Players.PlayerAdded:Connect(function(player)
                                                                        loadAllUsersData()
                                                                        loadPostsIndex()
                                                                        loadPlayerData(player)
                                                                        print("FaceBlox: " .. player.DisplayName .. " conectado")
                                                                        saveAllUsersData()
                                                                    end)
                                                                    
                                                                    Players.PlayerRemoving:Connect(function(player)
                                                                        savePlayerData(player)
                                                                        if allUsers[tostring(player.UserId)] then allUsers[tostring(player.UserId)].lastSeen = os.time() end
                                                                        saveAllUsersData()
                                                                        playerData[player.UserId] = nil
                                                                        print("FaceBlox: " .. player.DisplayName .. " desconectado")
                                                                    end)
                                                                    
                                                                    print("=================================")
                                                                    print("✨ FACEBLOX SERVER ACTUALIZADO (admin sync + reproductor con tiempo) ✨")
                                                                    print("=================================")




















-- FaceBlox_Client_01_UI
-- Parte 1: creación completa de la UI y variables globales de estado (sin lógica de remotes).
-- Este script crea exactamente la interfaz que tenías en tu Local original.

local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Desactivar controles de CoreGui
StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.Backpack, false)
StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.PlayerList, false)
StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.Health, false)
StarterGui:SetCore("ResetButtonCallback", false)

-- Desactivar movimiento del jugador (PlatformStand)
wait(1)
if player.Character and player.Character:FindFirstChild("Humanoid") then
    pcall(function() player.Character.Humanoid.PlatformStand = true end)
    end
        player.CharacterAdded:Connect(function(character)
            local humanoid = character:WaitForChild("Humanoid")
            humanoid.PlatformStand = true
        end)
        
        -- Variables de estado (exportadas vía _G)
        _G.FaceBlox = _G.FaceBlox or {}
        _G.FaceBlox.state = _G.FaceBlox.state or {}
        local state = _G.FaceBlox.state
        
        state.currentView = "feed"
        state.currentProfileId = player.UserId
        state.currentPostId = nil
        state.selectedMusicId = ""
        state.postWidgets = {}
        state.commentWidgets = {}
        state.availableMusic = { -- vacía por defecto; la llenará servidor o admin más tarde
        -- {id="...", title="..."}, etc.
        }
        
        -- Crear ScreenGui principal
        local screenGui = Instance.new("ScreenGui")
        screenGui.Name = "FaceBloxGui"
        screenGui.ResetOnSpawn = false
        screenGui.IgnoreGuiInset = true
        screenGui.Parent = playerGui
        
        -- Frame principal
        local mainFrame = Instance.new("Frame")
        mainFrame.Name = "MainFrame"
        mainFrame.Size = UDim2.new(1, 0, 1, 0)
        mainFrame.Position = UDim2.new(0, 0, 0, 0)
        mainFrame.BackgroundColor3 = Color3.fromRGB(18, 18, 18)
        mainFrame.BorderSizePixel = 0
        mainFrame.Parent = screenGui
        
        -- Header con gradiente
        local headerFrame = Instance.new("Frame")
        headerFrame.Name = "HeaderFrame"
        headerFrame.Size = UDim2.new(1, 0, 0, 60)
        headerFrame.Position = UDim2.new(0, 0, 0, 0)
        headerFrame.BackgroundColor3 = Color3.fromRGB(59, 89, 152)
        headerFrame.BorderSizePixel = 0
        headerFrame.Parent = mainFrame
        
        local headerGradient = Instance.new("UIGradient")
        headerGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(59, 89, 152)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(45, 70, 120))
        }
        headerGradient.Rotation = 90
        headerGradient.Parent = headerFrame
        
        -- Logo
        local logoLabel = Instance.new("TextLabel")
        logoLabel.Name = "LogoLabel"
        logoLabel.Size = UDim2.new(0, 150, 1, 0)
        logoLabel.Position = UDim2.new(0, 10, 0, 0)
        logoLabel.BackgroundTransparency = 1
        logoLabel.Text = "FaceBlox"
        logoLabel.TextColor3 = Color3.new(1, 1, 1)
        logoLabel.TextScaled = true
        logoLabel.Font = Enum.Font.SourceSansBold
        logoLabel.Parent = headerFrame
        
        -- Search box (solo visible en descubrir)
        local searchFrame = Instance.new("Frame")
        searchFrame.Name = "SearchFrame"
        searchFrame.Size = UDim2.new(0, 250, 0, 35)
        searchFrame.Position = UDim2.new(0.5, -125, 0.5, -17)
        searchFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        searchFrame.BorderSizePixel = 0
        searchFrame.Visible = false
        searchFrame.Parent = headerFrame
        
        local searchCorner = Instance.new("UICorner")
        searchCorner.CornerRadius = UDim.new(0, 17)
        searchCorner.Parent = searchFrame
        
        local searchBox = Instance.new("TextBox")
        searchBox.Name = "SearchBox"
        searchBox.Size = UDim2.new(1, -10, 1, 0)
        searchBox.Position = UDim2.new(0, 5, 0, 0)
        searchBox.BackgroundTransparency = 1
        searchBox.Text = ""
        searchBox.PlaceholderText = "Buscar usuarios..."
        searchBox.TextColor3 = Color3.fromRGB(50, 50, 50)
        searchBox.TextScaled = true
        searchBox.Font = Enum.Font.SourceSans
        searchBox.Parent = searchFrame
        
        local searchIndicator = Instance.new("TextLabel")
        searchIndicator.Name = "SearchIndicator"
        searchIndicator.Size = UDim2.new(0, 200, 0, 30)
        searchIndicator.Position = UDim2.new(0.5, -100, 1, 5)
        searchIndicator.BackgroundColor3 = Color3.fromRGB(255, 193, 7)
        searchIndicator.BorderSizePixel = 0
        searchIndicator.Text = "🔍 Buscando..."
        searchIndicator.TextColor3 = Color3.new(0, 0, 0)
        searchIndicator.Font = Enum.Font.SourceSansBold
        searchIndicator.TextSize = 14
        searchIndicator.Visible = false
        searchIndicator.Parent = searchFrame
        
        local indicatorCorner = Instance.new("UICorner")
        indicatorCorner.CornerRadius = UDim.new(0, 8)
        indicatorCorner.Parent = searchIndicator
        
        -- Foto de perfil del usuario (clickeable)
        local profileButton = Instance.new("ImageButton")
        profileButton.Name = "ProfileButton"
        profileButton.Size = UDim2.new(0, 45, 0, 45)
        profileButton.Position = UDim2.new(1, -55, 0.5, -22)
        profileButton.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
        profileButton.BorderSizePixel = 0
        profileButton.Image = "rbxasset://textures/face.png"
        profileButton.Parent = headerFrame
        
        local profileCorner = Instance.new("UICorner")
        profileCorner.CornerRadius = UDim.new(0.5, 0)
        profileCorner.Parent = profileButton
        
        -- Botón de vincular perfil
        local linkProfileBtn = Instance.new("TextButton")
        linkProfileBtn.Name = "LinkProfileBtn"
        linkProfileBtn.Size = UDim2.new(0, 20, 0, 20)
        linkProfileBtn.Position = UDim2.new(1, -75, 0.5, -32)
        linkProfileBtn.BackgroundColor3 = Color3.fromRGB(46, 125, 50)
        linkProfileBtn.BorderSizePixel = 0
        linkProfileBtn.Text = "🔗"
        linkProfileBtn.TextColor3 = Color3.new(1, 1, 1)
        linkProfileBtn.Font = Enum.Font.SourceSansBold
        linkProfileBtn.TextSize = 12
        linkProfileBtn.Parent = headerFrame
        
        local linkCorner = Instance.new("UICorner")
        linkCorner.CornerRadius = UDim.new(0.5, 0)
        linkCorner.Parent = linkProfileBtn
        
        -- Badge de verificación del usuario actual
        local verifiedBadge = Instance.new("ImageLabel")
        verifiedBadge.Name = "VerifiedBadge"
        verifiedBadge.Size = UDim2.new(0, 15, 0, 15)
        verifiedBadge.Position = UDim2.new(1, -10, 0, 2)
        verifiedBadge.BackgroundTransparency = 1
        verifiedBadge.Image = "rbxassetid://125268479387354"
        verifiedBadge.ImageColor3 = Color3.fromRGB(29, 161, 242)
        verifiedBadge.Visible = false
        verifiedBadge.Parent = profileButton
        
        -- Contenido principal
        local contentFrame = Instance.new("Frame")
        contentFrame.Name = "ContentFrame"
        contentFrame.Size = UDim2.new(1, 0, 1, -140)
        contentFrame.Position = UDim2.new(0, 0, 0, 60)
        contentFrame.BackgroundTransparency = 1
        contentFrame.Parent = mainFrame
        
        -- MUSIC SELECTION
        local musicSection = Instance.new("ScrollingFrame")
        musicSection.Name = "MusicSection"
        musicSection.Size = UDim2.new(1, -20, 1, 0)
        musicSection.Position = UDim2.new(0, 10, 0, 0)
        musicSection.BackgroundTransparency = 1
        musicSection.BorderSizePixel = 0
        musicSection.Visible = false
        musicSection.Parent = contentFrame
        
        local musicLayout = Instance.new("UIListLayout")
        musicLayout.SortOrder = Enum.SortOrder.LayoutOrder
        musicLayout.Padding = UDim.new(0, 10)
        musicLayout.Parent = musicSection
        
        -- FEED
        local feedScroll = Instance.new("ScrollingFrame")
        feedScroll.Name = "FeedSection"
        feedScroll.Size = UDim2.new(1, -20, 1, 0)
        feedScroll.Position = UDim2.new(0, 10, 0, 0)
        feedScroll.BackgroundTransparency = 1
        feedScroll.BorderSizePixel = 0
        feedScroll.Visible = true
        feedScroll.Parent = contentFrame
        
        local feedLayout = Instance.new("UIListLayout")
        feedLayout.SortOrder = Enum.SortOrder.LayoutOrder
        feedLayout.Padding = UDim.new(0, 10)
        feedLayout.Parent = feedScroll
        
        -- DISCOVER
        local discoverFrame = Instance.new("ScrollingFrame")
        discoverFrame.Name = "DiscoverSection"
        discoverFrame.Size = UDim2.new(1, -20, 1, 0)
        discoverFrame.Position = UDim2.new(0, 10, 0, 0)
        discoverFrame.BackgroundTransparency = 1
        discoverFrame.BorderSizePixel = 0
        discoverFrame.Visible = false
        discoverFrame.Parent = contentFrame
        
        local discoverLayout = Instance.new("UIListLayout")
        discoverLayout.SortOrder = Enum.SortOrder.LayoutOrder
        discoverLayout.Padding = UDim.new(0, 10)
        discoverLayout.Parent = discoverFrame
        
        -- CREATE
        local createFrame = Instance.new("Frame")
        createFrame.Name = "CreateSection"
        createFrame.Size = UDim2.new(1, -20, 1, 0)
        createFrame.Position = UDim2.new(0, 10, 0, 0)
        createFrame.BackgroundTransparency = 1
        createFrame.Visible = false
        createFrame.Parent = contentFrame
        
        -- SETTINGS (PROFILE)
        local settingsFrame = Instance.new("ScrollingFrame")
        settingsFrame.Name = "SettingsSection"
        settingsFrame.Size = UDim2.new(1, -20, 1, 0)
        settingsFrame.Position = UDim2.new(0, 10, 0, 0)
        settingsFrame.BackgroundTransparency = 1
        settingsFrame.BorderSizePixel = 0
        settingsFrame.Visible = false
        settingsFrame.Parent = contentFrame
        
        local settingsLayout = Instance.new("UIListLayout")
        settingsLayout.SortOrder = Enum.SortOrder.LayoutOrder
        settingsLayout.Padding = UDim.new(0, 15)
        settingsLayout.Parent = settingsFrame
        
        -- COMMENTS SECTION
        local commentsSection = Instance.new("ScrollingFrame")
        commentsSection.Name = "CommentsSection"
        commentsSection.Size = UDim2.new(1, -20, 1, 0)
        commentsSection.Position = UDim2.new(0, 10, 0, 0)
        commentsSection.BackgroundColor3 = Color3.fromRGB(25,25,25)
        commentsSection.Visible = false
        commentsSection.BorderSizePixel = 0
        commentsSection.Parent = contentFrame
        
        local commentsLayout = Instance.new("UIListLayout")
        commentsLayout.SortOrder = Enum.SortOrder.LayoutOrder
        commentsLayout.Padding = UDim.new(0, 10)
        commentsLayout.Parent = commentsSection
        
        -- REPORT SECTION
        local reportSection = Instance.new("Frame")
        reportSection.Name = "ReportSection"
        reportSection.Size = UDim2.new(1, 0, 1, -60)
        reportSection.Position = UDim2.new(0, 0, 0, 0)
        reportSection.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
        reportSection.Visible = false
        reportSection.BorderSizePixel = 0
        reportSection.Parent = contentFrame
        
        -- Barra de navegación inferior
        local navBar = Instance.new("Frame")
        navBar.Name = "NavBar"
        navBar.Size = UDim2.new(1, 0, 0, 80)
        navBar.Position = UDim2.new(0, 0, 1, -80)
        navBar.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        navBar.BorderSizePixel = 0
        navBar.Parent = mainFrame
        
        local navButtons = {
        {name = "Inicio", icon = "🏠", view = "feed"},
        {name = "Descubrir", icon = "🔍", view = "discover"},
        {name = "Crear", icon = "➕", view = "create"},
        {name = "Perfil", icon = "👤", view = "settings"}
        }
        
        local navButtonInstances = {}
        
        -- <<< CREACIÓN COMPLETA DE BOTONES DE NAVEGACIÓN >>>
        for i, buttonData in ipairs(navButtons) do
            local navButton = Instance.new("TextButton")
            navButton.Size = UDim2.new(1/#navButtons, 0, 1, 0)
            navButton.Position = UDim2.new((i-1)/#navButtons, 0, 0, 0)
            navButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            navButton.BorderSizePixel = 0
            navButton.Text = ""
            navButton.Parent = navBar
            
            if buttonData.view == "feed" then
                local icon = Instance.new("ImageLabel")
                icon.Name = "NavIcon"
                icon.Size = UDim2.new(0, 36, 0, 36)
                icon.Position = UDim2.new(0.5, -18, 0, 8)
                icon.BackgroundTransparency = 1
                icon.Image = "rbxassetid://120125722355552"
                icon.Parent = navButton
                local iconCorner = Instance.new("UICorner")
                iconCorner.CornerRadius = UDim.new(0, 8)
                iconCorner.Parent = icon
            else
                local iconLabel = Instance.new("TextLabel")
                iconLabel.Name = "NavIcon"
                iconLabel.Size = UDim2.new(1, 0, 0, 36)
                iconLabel.Position = UDim2.new(0, 0, 0, 8)
                iconLabel.BackgroundTransparency = 1
                iconLabel.Text = buttonData.icon
                iconLabel.TextColor3 = Color3.new(1, 1, 1)
                iconLabel.TextScaled = true
                iconLabel.Font = Enum.Font.SourceSans
                iconLabel.Parent = navButton
            end
            
            local nameLabel = Instance.new("TextLabel")
            nameLabel.Name = "NavLabel"
            nameLabel.Size = UDim2.new(1, 0, 0, 30)
            nameLabel.Position = UDim2.new(0, 0, 0, 50)
            nameLabel.BackgroundTransparency = 1
            nameLabel.Text = buttonData.name
            nameLabel.TextColor3 = Color3.new(1, 1, 1)
            nameLabel.TextScaled = true
            nameLabel.Font = Enum.Font.SourceSans
            nameLabel.Parent = navButton
            
            navButtonInstances[buttonData.view] = navButton
        end
        -- <<< FIN CREACIÓN NAV >>>
        
        -- Exportar referencias UI y navButtons a _G para que otras partes las usen
        _G.FaceBlox.ui = _G.FaceBlox.ui or {}
        local ui = _G.FaceBlox.ui
        ui.screenGui = screenGui
        ui.mainFrame = mainFrame
        ui.headerFrame = headerFrame
        ui.logoLabel = logoLabel
        ui.searchFrame = searchFrame
        ui.searchBox = searchBox
        ui.searchIndicator = searchIndicator
        ui.profileButton = profileButton
        ui.linkProfileBtn = linkProfileBtn
        ui.verifiedBadge = verifiedBadge
        ui.contentFrame = contentFrame
        ui.feedScroll = feedScroll
        ui.feedLayout = feedLayout
        ui.discoverFrame = discoverFrame
        ui.discoverLayout = discoverLayout
        ui.createFrame = createFrame
        ui.settingsFrame = settingsFrame
        ui.settingsLayout = settingsLayout
        ui.commentsSection = commentsSection
        ui.commentsLayout = commentsLayout
        ui.musicSection = musicSection
        ui.musicLayout = musicLayout
        ui.reportSection = reportSection
        ui.navBar = navBar
        ui.navButtonInstances = navButtonInstances
        
        print("FaceBlox Cliente - Parte 01 (UI) cargada.")



- FaceBlox_Client_02_PostsAndComments
-- Parte 2: createPostFrame, showCommentsSection, createCommentWidget, verificación, helpers.
-- Este script usa la UI creada por Parte 1 (la busca en PlayerGui).
 
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
 
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
 
-- Esperar UI de Parte1
local gui = playerGui:WaitForChild("FaceBloxGui")
local ui = (_G.FaceBlox and _G.FaceBlox.ui) or {
feedScroll = gui:WaitForChild("ContentFrame"):WaitForChild("FeedSection")
}
-- referencias locales
local feedScroll = ui.feedScroll
local feedLayout = ui.feedLayout
local commentsSection = ui.commentsSection
local commentsLayout = ui.commentsLayout
local musicSection = ui.musicSection
local musicLayout = ui.musicLayout
 
-- usar state y availableMusic desde _G
local state = _G.FaceBlox.state
 
-- Helpers de verificación (dos variantes; mantenemos ambas como en tu código original)
local function createVerificationBadge(parent, isVerified, xOffset, yOffset)
    if isVerified then
        local badge = Instance.new("ImageLabel")
        badge.Size = UDim2.new(0, 16, 0, 16)
        badge.Position = UDim2.new(0, xOffset or 0, 0, yOffset or 0)
        badge.BackgroundTransparency = 1
        badge.Image = "rbxassetid://125268479387354"
        badge.ImageColor3 = Color3.fromRGB(29, 161, 242)
        badge.Parent = parent
        return badge
    end
    return nil
end
 
local function createVerificationBadgeNextTo(textLabel, isVerified)
    if not isVerified then return nil end
    local parent = textLabel.Parent
    local badge = Instance.new("ImageLabel")
    badge.Name = "Badge_Verified"
    badge.Size = UDim2.new(0, 16, 0, 16)
    badge.BackgroundTransparency = 1
    badge.Image = "rbxassetid://125268479387354"
    badge.ImageColor3 = Color3.fromRGB(29, 161, 242)
    badge.AnchorPoint = Vector2.new(0, 0)
    badge.Parent = parent
    spawn(function()
        wait(0.05)
        local textExtentX = 0
        pcall(function() textExtentX = textLabel.TextBounds.X end)
            local x = (textLabel.Position and textLabel.Position.X.Offset or 0) + textExtentX + 8
            local y = (textLabel.Position and textLabel.Position.Y.Offset or 0) + (textLabel.Size and textLabel.Size.Y.Offset/2 - 8 or 0)
            badge.Position = UDim2.new(0, x, 0, y)
        end)
        return badge
    end
    
    -- getMusicTitle (usa state.availableMusic)
    local function getMusicTitle(musicId)
        for _, music in ipairs(state.availableMusic or {}) do
            if music.id == musicId then
                return music.title
            end
        end
        return "Música desconocida"
    end
    
    -- createPostFrame (copia fiel de tu bloque original con player interaction y reproductor)
    local function createPostFrame(postData)
        local idStr = tostring(postData.id)
        local postFrame = Instance.new("Frame")
        postFrame.Name = "PostFrame_" .. idStr
        postFrame.Size = UDim2.new(1, 0, 0, 10)
        postFrame.AutomaticSize = Enum.AutomaticSize.Y
        postFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        postFrame.BorderSizePixel = 0
        postFrame.Parent = feedScroll
        
        local postCorner = Instance.new("UICorner")
        postCorner.CornerRadius = UDim.new(0, 10)
        postCorner.Parent = postFrame
        
        local postLayout = Instance.new("UIListLayout")
        postLayout.Padding = UDim.new(0, 6)
        postLayout.SortOrder = Enum.SortOrder.LayoutOrder
        postLayout.Parent = postFrame
        
        -- Header del post
        local postHeader = Instance.new("Frame")
        postHeader.Name = "Header"
        postHeader.Size = UDim2.new(1, 0, 0, 60)
        postHeader.BackgroundTransparency = 1
        postHeader.Parent = postFrame
        
        -- Foto de perfil del autor
        local authorPic = Instance.new("ImageButton")
        authorPic.Size = UDim2.new(0, 44, 0, 44)
        authorPic.Position = UDim2.new(0, 10, 0, 8)
        authorPic.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
        authorPic.BorderSizePixel = 0
        authorPic.Image = postData.profilePicture or ("https://www.roblox.com/headshot-thumbnail/image?userId=" .. tostring(postData.authorId) .. "&width=150&height=150&format=png")
        authorPic.Parent = postHeader
        
        local authorPicCorner = Instance.new("UICorner")
        authorPicCorner.CornerRadius = UDim.new(0.5, 0)
        authorPicCorner.Parent = authorPic
        
        -- Nombre del autor
        local authorName = Instance.new("TextLabel")
        authorName.Size = UDim2.new(0, 300, 0, 22)
        authorName.Position = UDim2.new(0, 64, 0, 8)
        authorName.BackgroundTransparency = 1
        authorName.Text = postData.authorName
        authorName.TextColor3 = Color3.new(1, 1, 1)
        authorName.TextScaled = false
        authorName.Font = Enum.Font.SourceSansBold
        authorName.TextSize = 18
        authorName.TextXAlignment = Enum.TextXAlignment.Left
        authorName.Parent = postHeader
        
        -- Verificación al lado del nombre
        createVerificationBadgeNextTo(authorName, postData.isVerified)
        
        -- Username debajo del display name
        local authorUsername = Instance.new("TextLabel")
        authorUsername.Size = UDim2.new(0, 300, 0, 18)
        authorUsername.Position = UDim2.new(0, 64, 0, 28)
        authorUsername.BackgroundTransparency = 1
        authorUsername.Text = "@" .. (postData.authorUsername or "usuario")
        authorUsername.TextColor3 = Color3.fromRGB(150, 150, 150)
        authorUsername.TextScaled = false
        authorUsername.Font = Enum.Font.SourceSans
        authorUsername.TextSize = 14
        authorUsername.TextXAlignment = Enum.TextXAlignment.Left
        authorUsername.Parent = postHeader
        
        -- Tiempo
        local timeLabel = Instance.new("TextLabel")
        timeLabel.Size = UDim2.new(0, 140, 0, 18)
        timeLabel.Position = UDim2.new(1, -150, 0, 10)
        timeLabel.BackgroundTransparency = 1
        timeLabel.Text = os.date("%d/%m/%Y %H:%M", postData.timestamp)
        timeLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
        timeLabel.TextScaled = false
        timeLabel.Font = Enum.Font.SourceSans
        timeLabel.TextSize = 14
        timeLabel.TextXAlignment = Enum.TextXAlignment.Right
        timeLabel.Parent = postHeader
        
        -- Contenido del post
        local contentLabel = Instance.new("TextLabel")
        contentLabel.Name = "Content"
        contentLabel.Size = UDim2.new(1, -20, 0, 10)
        contentLabel.Position = UDim2.new(0, 10, 0, 60)
        contentLabel.BackgroundTransparency = 1
        contentLabel.Text = postData.content or ""
        contentLabel.TextColor3 = Color3.new(1, 1, 1)
        contentLabel.TextWrapped = true
        contentLabel.Font = Enum.Font.SourceSans
        contentLabel.TextSize = 20
        contentLabel.TextYAlignment = Enum.TextYAlignment.Top
        contentLabel.AutomaticSize = Enum.AutomaticSize.Y
        contentLabel.Parent = postFrame
        
        -- Reproductor de música (si existe) con animación y tiempo (debajo del icono de música)
        if postData.musicId and postData.musicId ~= "" then
            local musicFrame = Instance.new("Frame")
            musicFrame.Name = "MusicPlayer"
            musicFrame.Size = UDim2.new(1, -20, 0, 90)
            musicFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
            musicFrame.BorderSizePixel = 0
            musicFrame.Parent = postFrame
            
            local musicCorner = Instance.new("UICorner")
            musicCorner.CornerRadius = UDim.new(0, 8)
            musicCorner.Parent = musicFrame
            
            local musicIcon = Instance.new("TextLabel")
            musicIcon.Size = UDim2.new(0, 40, 0, 40)
            musicIcon.Position = UDim2.new(0, 10, 0, 10)
            musicIcon.BackgroundTransparency = 1
            musicIcon.Text = "🎵"
            musicIcon.TextScaled = true
            musicIcon.Font = Enum.Font.SourceSansBold
            musicIcon.Parent = musicFrame
            
            local musicTitle = Instance.new("TextLabel")
            musicTitle.Size = UDim2.new(0, 260, 0, 20)
            musicTitle.Position = UDim2.new(0, 60, 0, 10)
            musicTitle.BackgroundTransparency = 1
            musicTitle.Text = getMusicTitle(postData.musicId)
            musicTitle.TextColor3 = Color3.new(1, 1, 1)
            musicTitle.Font = Enum.Font.SourceSansBold
            musicTitle.TextSize = 16
            musicTitle.TextXAlignment = Enum.TextXAlignment.Left
            musicTitle.Parent = musicFrame
            
            local timeInfo = Instance.new("TextLabel")
            timeInfo.Size = UDim2.new(0, 200, 0, 18)
            timeInfo.Position = UDim2.new(0, 60, 0, 34)
            timeInfo.BackgroundTransparency = 1
            timeInfo.Text = "Duración: --:--  •  Restante: --:--"
            timeInfo.TextColor3 = Color3.fromRGB(200, 200, 200)
            timeInfo.Font = Enum.Font.SourceSans
            timeInfo.TextSize = 14
            timeInfo.TextXAlignment = Enum.TextXAlignment.Left
            timeInfo.Parent = musicFrame
            
            local progressBg = Instance.new("Frame")
            progressBg.Size = UDim2.new(0, 260, 0, 6)
            progressBg.Position = UDim2.new(0, 60, 0, 56)
            progressBg.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
            progressBg.BorderSizePixel = 0
            progressBg.Parent = musicFrame
            
            local progressFill = Instance.new("Frame")
            progressFill.Size = UDim2.new(0, 0, 1, 0)
            progressFill.Position = UDim2.new(0, 0, 0, 0)
            progressFill.BackgroundColor3 = Color3.fromRGB(29, 161, 242)
            progressFill.BorderSizePixel = 0
            progressFill.Parent = progressBg
            
            local playButton = Instance.new("TextButton")
            playButton.Size = UDim2.new(0, 80, 0, 35)
            playButton.Position = UDim2.new(1, -90, 0, 12)
            playButton.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
            playButton.BorderSizePixel = 0
            playButton.Text = "▶ Play"
            playButton.TextColor3 = Color3.new(1, 1, 1)
            playButton.Font = Enum.Font.SourceSansBold
            playButton.TextSize = 14
            playButton.Parent = musicFrame
            
            local musicPlayer = Instance.new("Sound")
            musicPlayer.SoundId = "rbxassetid://" .. postData.musicId
            musicPlayer.Volume = 0.6
            musicPlayer.Parent = workspace
            
            local isPlaying = false
            local updateConn
            
            local function formatTime(sec)
                sec = math.max(0, tonumber(sec) or 0)
                local m = math.floor(sec / 60)
                local s = math.floor(sec % 60)
                return string.format("%02d:%02d", m, s)
            end
            
            local function stopUpdate()
                if updateConn then
                    updateConn:Disconnect()
                    updateConn = nil
                end
            end
            
            local function startUpdate()
                stopUpdate()
                updateConn = RunService.Heartbeat:Connect(function()
                    if not musicPlayer.IsLoaded then return end
                    local len = musicPlayer.TimeLength or 0
                    local pos = musicPlayer.TimePosition or 0
                    local remaining = math.max(0, len - pos)
                    timeInfo.Text = string.format("Duración: %s  •  Restante: %s", formatTime(len), formatTime(remaining))
                    local pct = (len > 0) and math.clamp(pos / len, 0, 1) or 0
                    progressFill.Size = UDim2.new(pct, 0, 1, 0)
                end)
            end
            
            musicPlayer.Loaded:Connect(function()
                local len = musicPlayer.TimeLength or 0
                timeInfo.Text = string.format("Duración: %s  •  Restante: %s", formatTime(len), formatTime(len))
            end)
            
            musicPlayer.Ended:Connect(function()
                isPlaying = false
                playButton.Text = "▶ Play"
                playButton.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
                stopUpdate()
                progressFill.Size = UDim2.new(0, 0, 1, 0)
                timeInfo.Text = "Duración: " .. formatTime(musicPlayer.TimeLength or 0) .. "  •  Restante: 00:00"
            end)
            
            playButton.MouseButton1Click:Connect(function()
                if not isPlaying then
                    if not musicPlayer.IsLoaded then
                        pcall(function() musicPlayer:LoadAsync() end)
                        end
                            pcall(function() musicPlayer:Play() end)
                                isPlaying = true
                                playButton.Text = "⏸ Pause"
                                playButton.BackgroundColor3 = Color3.fromRGB(255, 152, 0)
                                startUpdate()
                            else
                                pcall(function() musicPlayer:Pause() end)
                                    isPlaying = false
                                    playButton.Text = "▶ Play"
                                    playButton.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
                                    stopUpdate()
                                end
                            end)
                            
                            postFrame.Destroying:Connect(function()
                                stopUpdate()
                                pcall(function() musicPlayer:Destroy() end)
                                end)
                                end
                                    
                                    -- Botones de interacción (like / comment)
                                    local interactionFrame = Instance.new("Frame")
                                    interactionFrame.Name = "Interaction"
                                    interactionFrame.Size = UDim2.new(1, 0, 0, 42)
                                    interactionFrame.BackgroundTransparency = 1
                                    interactionFrame.Parent = postFrame
                                    
                                    local likeButton = Instance.new("TextButton")
                                    likeButton.Size = UDim2.new(0, 110, 0, 36)
                                    likeButton.Position = UDim2.new(0, 10, 0, 3)
                                    likeButton.BorderSizePixel = 0
                                    likeButton.TextColor3 = Color3.new(1, 1, 1)
                                    likeButton.TextScaled = false
                                    likeButton.Font = Enum.Font.SourceSansBold
                                    likeButton.TextSize = 18
                                    likeButton.Parent = interactionFrame
                                    
                                    local commentButton = Instance.new("TextButton")
                                    commentButton.Size = UDim2.new(0, 130, 0, 36)
                                    commentButton.Position = UDim2.new(0, 130, 0, 3)
                                    commentButton.BorderSizePixel = 0
                                    commentButton.TextColor3 = Color3.new(1, 1, 1)
                                    commentButton.TextScaled = false
                                    commentButton.Font = Enum.Font.SourceSansBold
                                    commentButton.TextSize = 18
                                    commentButton.Parent = interactionFrame
                                    
                                    -- Inicializar estados
                                    local likesCount = postData.likesCount or 0
                                    local commentsCount = postData.commentsCount or 0
                                    local isLiked = postData.isLikedByUser or false
                                    
                                    likeButton.Text = (isLiked and "❤ " or "♡ ") .. tostring(likesCount)
                                    likeButton.BackgroundColor3 = isLiked and Color3.fromRGB(233, 69, 96) or Color3.fromRGB(60, 60, 60)
                                    commentButton.Text = "💬 " .. tostring(commentsCount)
                                    commentButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
                                    
                                    -- Guardar referencias en state.postWidgets
                                    state.postWidgets[idStr] = {
                                    frame = postFrame,
                                    likeButton = likeButton,
                                    commentButton = commentButton,
                                    likesCount = likesCount,
                                    commentsCount = commentsCount,
                                    isLikedByUser = isLiked,
                                    contentLabel = contentLabel,
                                    postId = idStr
                                    }
                                    
                                    -- Eventos locales: authorPic, likeButton, commentButton
                                    authorPic.MouseButton1Click:Connect(function()
                                        if _G and _G.FaceBlox and type(_G.FaceBlox.functions) == "table" and type(_G.FaceBlox.functions.showUserProfile) == "function" then
                                            _G.FaceBlox.functions.showUserProfile(tonumber(postData.authorId))
                                            end
                                            end)
                                                
                                                likeButton.MouseButton1Click:Connect(function()
                                                    local wasLiked = state.postWidgets[idStr].isLikedByUser
                                                    state.postWidgets[idStr].isLikedByUser = not wasLiked
                                                    state.postWidgets[idStr].likesCount = state.postWidgets[idStr].likesCount + (wasLiked and -1 or 1)
                                                    state.postWidgets[idStr].likeButton.BackgroundColor3 = state.postWidgets[idStr].isLikedByUser and Color3.fromRGB(233, 69, 96) or Color3.fromRGB(60, 60, 60)
                                                    state.postWidgets[idStr].likeButton.Text = (state.postWidgets[idStr].isLikedByUser and "❤ " or "♡ ") .. tostring(state.postWidgets[idStr].likesCount)
                                                    -- FireServer se hace desde Parte 4 (remotes). Aquí simplemente intentamos usar referencias si existen.
                                                    if _G and _G.FaceBlox and _G.FaceBlox.remoteEvents and _G.FaceBlox.remoteEvents.LikePost then
                                                        pcall(function() _G.FaceBlox.remoteEvents.LikePost:FireServer(idStr) end)
                                                        end
                                                        end)
                                                            
                                                            commentButton.MouseButton1Click:Connect(function()
                                                                if _G and _G.FaceBlox and type(_G.FaceBlox.functions.showCommentsSection) == "function" then
                                                                    _G.FaceBlox.functions.showCommentsSection(idStr)
                                                                    end
                                                                    end)
                                                                        
                                                                        return postFrame
                                                                    end
                                                                    
                                                                    -- showCommentsSection (gran bloque copiado tal como en tu original)
                                                                    local function showCommentsSection(postId)
                                                                        _G.FaceBlox.state.currentPostId = postId
                                                                        
                                                                        -- Ocultar otras secciones
                                                                        ui.feedScroll.Visible = false
                                                                        ui.discoverFrame.Visible = false
                                                                        ui.createFrame.Visible = false
                                                                        ui.settingsFrame.Visible = false
                                                                        ui.commentsSection.Visible = true
                                                                        
                                                                        ui.navBar.Visible = false
                                                                        ui.headerFrame.Visible = false
                                                                        ui.contentFrame.Size = UDim2.new(1, 0, 1, 0)
                                                                        ui.contentFrame.Position = UDim2.new(0, 0, 0, 0)
                                                                        
                                                                        -- Limpiar commentsSection
                                                                        for _, child in pairs(ui.commentsSection:GetChildren()) do
                                                                            if child ~= ui.commentsLayout then
                                                                                child:Destroy()
                                                                            end
                                                                        end
                                                                        state.commentWidgets = {}
                                                                        
                                                                        -- Header
                                                                        local header = Instance.new("Frame")
                                                                        header.Size = UDim2.new(1, 0, 0, 60)
                                                                        header.Position = UDim2.new(0, 0, 0, 0)
                                                                        header.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
                                                                        header.Parent = ui.commentsSection
                                                                        
                                                                        local title = Instance.new("TextLabel")
                                                                        title.Size = UDim2.new(1, -100, 1, 0)
                                                                        title.Position = UDim2.new(0, 20, 0, 0)
                                                                        title.BackgroundTransparency = 1
                                                                        title.Text = "Comentarios"
                                                                        title.Font = Enum.Font.SourceSansBold
                                                                        title.TextSize = 20
                                                                        title.TextColor3 = Color3.new(1, 1, 1)
                                                                        title.Parent = header
                                                                        
                                                                        local closeBtn = Instance.new("TextButton")
                                                                        closeBtn.Size = UDim2.new(0, 80, 0, 40)
                                                                        closeBtn.Position = UDim2.new(1, -90, 0.5, -20)
                                                                        closeBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
                                                                        closeBtn.Text = "Cerrar"
                                                                        closeBtn.Font = Enum.Font.SourceSansBold
                                                                        closeBtn.TextColor3 = Color3.new(1,1,1)
                                                                        closeBtn.Parent = header
                                                                        closeBtn.MouseButton1Click:Connect(function()
                                                                            ui.commentsSection.Visible = false
                                                                            ui.navBar.Visible = true
                                                                            ui.headerFrame.Visible = true
                                                                            ui.contentFrame.Size = UDim2.new(1, 0, 1, -140)
                                                                            ui.contentFrame.Position = UDim2.new(0, 0, 0, 60)
                                                                            if _G and _G.FaceBlox and type(_G.FaceBlox.functions.switchView) == "function" then
                                                                                _G.FaceBlox.functions.switchView("feed")
                                                                                end
                                                                                end)
                                                                                    
                                                                                    -- Scroll con comentarios
                                                                                    local commentsScroll = Instance.new("ScrollingFrame")
                                                                                    commentsScroll.Size = UDim2.new(1, 0, 1, -140)
                                                                                    commentsScroll.Position = UDim2.new(0, 0, 0, 60)
                                                                                    commentsScroll.BackgroundTransparency = 1
                                                                                    commentsScroll.Parent = ui.commentsSection
                                                                                    
                                                                                    local layout = Instance.new("UIListLayout")
                                                                                    layout.Parent = commentsScroll
                                                                                    layout.Padding = UDim.new(0, 10)
                                                                                    
                                                                                    -- Caja para escribir comentario (fija abajo)
                                                                                    local inputFrame = Instance.new("Frame")
                                                                                    inputFrame.Size = UDim2.new(1, 0, 0, 80)
                                                                                    inputFrame.Position = UDim2.new(0, 0, 1, -80)
                                                                                    inputFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
                                                                                    inputFrame.ZIndex = 10
                                                                                    inputFrame.Parent = ui.commentsSection
                                                                                    
                                                                                    local commentTextBox = Instance.new("TextBox")
                                                                                    commentTextBox.Size = UDim2.new(1, -120, 0, 40)
                                                                                    commentTextBox.Position = UDim2.new(0, 10, 0, 20)
                                                                                    commentTextBox.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
                                                                                    commentTextBox.BorderSizePixel = 0
                                                                                    commentTextBox.PlaceholderText = "Escribe un comentario..."
                                                                                    commentTextBox.Text = ""
                                                                                    commentTextBox.TextColor3 = Color3.new(1, 1, 1)
                                                                                    commentTextBox.Font = Enum.Font.SourceSans
                                                                                    commentTextBox.TextSize = 16
                                                                                    commentTextBox.Parent = inputFrame
                                                                                    
                                                                                    local inputCorner = Instance.new("UICorner")
                                                                                    inputCorner.CornerRadius = UDim.new(0, 8)
                                                                                    inputCorner.Parent = commentTextBox
                                                                                    
                                                                                    local postCommentButton = Instance.new("TextButton")
                                                                                    postCommentButton.Size = UDim2.new(0, 100, 0, 40)
                                                                                    postCommentButton.Position = UDim2.new(1, -110, 0, 20)
                                                                                    postCommentButton.BackgroundColor3 = Color3.fromRGB(66, 103, 178)
                                                                                    postCommentButton.BorderSizePixel = 0
                                                                                    postCommentButton.Text = "Comentar"
                                                                                    postCommentButton.TextColor3 = Color3.new(1, 1, 1)
                                                                                    postCommentButton.Font = Enum.Font.SourceSansBold
                                                                                    postCommentButton.TextSize = 16
                                                                                    postCommentButton.Parent = inputFrame
                                                                                    
                                                                                    local buttonCorner = Instance.new("UICorner")
                                                                                    buttonCorner.CornerRadius = UDim.new(0, 8)
                                                                                    buttonCorner.Parent = postCommentButton
                                                                                    
                                                                                    -- Crear widget de comentario local (igual que en tu original)
                                                                                    local function createCommentWidget(commentData)
                                                                                        local commentFrame = Instance.new("Frame")
                                                                                        commentFrame.Name = "Comment_" .. commentData.id
                                                                                        commentFrame.Size = UDim2.new(1, -20, 0, 80)
                                                                                        commentFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
                                                                                        commentFrame.BorderSizePixel = 0
                                                                                        commentFrame.AutomaticSize = Enum.AutomaticSize.Y
                                                                                        commentFrame.Parent = commentsScroll
                                                                                        
                                                                                        local commentCorner = Instance.new("UICorner")
                                                                                        commentCorner.CornerRadius = UDim.new(0, 8)
                                                                                        commentCorner.Parent = commentFrame
                                                                                        
                                                                                        local authorLabel = Instance.new("TextLabel")
                                                                                        authorLabel.Size = UDim2.new(1, -120, 0, 20)
                                                                                        authorLabel.Position = UDim2.new(0, 10, 0, 5)
                                                                                        authorLabel.BackgroundTransparency = 1
                                                                                        authorLabel.Font = Enum.Font.SourceSansBold
                                                                                        authorLabel.Text = commentData.authorName
                                                                                        authorLabel.TextColor3 = Color3.new(1,1,1)
                                                                                        authorLabel.TextSize = 16
                                                                                        authorLabel.TextXAlignment = Enum.TextXAlignment.Left
                                                                                        authorLabel.Parent = commentFrame
                                                                                        
                                                                                        createVerificationBadgeNextTo(authorLabel, commentData.isVerified)
                                                                                        
                                                                                        local usernameLabel = Instance.new("TextLabel")
                                                                                        usernameLabel.Size = UDim2.new(1, -120, 0, 16)
                                                                                        usernameLabel.Position = UDim2.new(0, 10, 0, 22)
                                                                                        usernameLabel.BackgroundTransparency = 1
                                                                                        usernameLabel.Font = Enum.Font.SourceSans
                                                                                        usernameLabel.Text = "@" .. (commentData.authorUsername or "usuario")
                                                                                        usernameLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
                                                                                        usernameLabel.TextSize = 14
                                                                                        usernameLabel.TextXAlignment = Enum.TextXAlignment.Left
                                                                                        usernameLabel.Parent = commentFrame
                                                                                        
                                                                                        local contentLabel = Instance.new("TextLabel")
                                                                                        contentLabel.Size = UDim2.new(1, -120, 0, 40)
                                                                                        contentLabel.Position = UDim2.new(0, 10, 0, 40)
                                                                                        contentLabel.BackgroundTransparency = 1
                                                                                        contentLabel.Font = Enum.Font.SourceSans
                                                                                        contentLabel.Text = commentData.content
                                                                                        contentLabel.TextWrapped = true
                                                                                        contentLabel.TextSize = 16
                                                                                        contentLabel.TextColor3 = Color3.fromRGB(220,220,220)
                                                                                        contentLabel.TextYAlignment = Enum.TextYAlignment.Top
                                                                                        contentLabel.AutomaticSize = Enum.AutomaticSize.Y
                                                                                        contentLabel.Parent = commentFrame
                                                                                        
                                                                                        local buttonFrame = Instance.new("Frame")
                                                                                        buttonFrame.Size = UDim2.new(0, 100, 0, 70)
                                                                                        buttonFrame.Position = UDim2.new(1, -110, 0, 5)
                                                                                        buttonFrame.BackgroundTransparency = 1
                                                                                        buttonFrame.Parent = commentFrame
                                                                                        
                                                                                        local reportCommentBtn = Instance.new("TextButton")
                                                                                        reportCommentBtn.Size = UDim2.new(0, 30, 0, 25)
                                                                                        reportCommentBtn.Position = UDim2.new(0, 5, 0, 5)
                                                                                        reportCommentBtn.BackgroundColor3 = Color3.fromRGB(220, 20, 60)
                                                                                        reportCommentBtn.BorderSizePixel = 0
                                                                                        reportCommentBtn.Text = "⚠"
                                                                                        reportCommentBtn.TextColor3 = Color3.new(1, 1, 1)
                                                                                        reportCommentBtn.Font = Enum.Font.SourceSansBold
                                                                                        reportCommentBtn.TextSize = 14
                                                                                        reportCommentBtn.Parent = buttonFrame
                                                                                        
                                                                                        if tostring(commentData.authorId) == tostring(player.UserId) or player.Name:lower() == "vegetl_t" then
                                                                                            local deleteCommentBtn = Instance.new("TextButton")
                                                                                            deleteCommentBtn.Size = UDim2.new(0, 30, 0, 25)
                                                                                            deleteCommentBtn.Position = UDim2.new(0, 40, 0, 5)
                                                                                            deleteCommentBtn.BackgroundColor3 = Color3.fromRGB(180, 180, 180)
                                                                                            deleteCommentBtn.BorderSizePixel = 0
                                                                                            deleteCommentBtn.Text = "🗑"
                                                                                            deleteCommentBtn.TextColor3 = Color3.new(0, 0, 0)
                                                                                            deleteCommentBtn.Font = Enum.Font.SourceSansBold
                                                                                            deleteCommentBtn.TextSize = 14
                                                                                            deleteCommentBtn.Parent = buttonFrame
                                                                                            
                                                                                            deleteCommentBtn.MouseButton1Click:Connect(function()
                                                                                                if _G and _G.FaceBlox and _G.FaceBlox.remoteEvents and _G.FaceBlox.remoteEvents.DeleteComment then
                                                                                                    pcall(function() _G.FaceBlox.remoteEvents.DeleteComment:FireServer(commentData.id) end)
                                                                                                    end
                                                                                                    end)
                                                                                                    end
                                                                                                        
                                                                                                        reportCommentBtn.MouseButton1Click:Connect(function()
                                                                                                            reportCommentBtn.Text = "✓"
                                                                                                            reportCommentBtn.BackgroundColor3 = Color3.fromRGB(46, 125, 50)
                                                                                                            wait(1)
                                                                                                            reportCommentBtn.Text = "⚠"
                                                                                                            reportCommentBtn.BackgroundColor3 = Color3.fromRGB(220, 20, 60)
                                                                                                        end)
                                                                                                        
                                                                                                        state.commentWidgets[commentData.id] = commentFrame
                                                                                                        return commentFrame
                                                                                                    end
                                                                                                    
                                                                                                    -- Cargar comentarios existentes (invocar GetComments desde remoteFunctions si existe)
                                                                                                    spawn(function()
                                                                                                        if _G and _G.FaceBlox and _G.FaceBlox.remoteFunctions and _G.FaceBlox.remoteFunctions.GetComments then
                                                                                                            local ok, commentsData = pcall(function()
                                                                                                                return _G.FaceBlox.remoteFunctions.GetComments:InvokeServer(postId)
                                                                                                            end)
                                                                                                            commentsData = ok and commentsData or {}
                                                                                                            for _, commentData in ipairs(commentsData) do
                                                                                                                if not commentData.deleted then
                                                                                                                    createCommentWidget(commentData)
                                                                                                                end
                                                                                                            end
                                                                                                            commentsScroll.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y)
                                                                                                        end
                                                                                                    end)
                                                                                                    
                                                                                                    postCommentButton.MouseButton1Click:Connect(function()
                                                                                                        if commentTextBox.Text ~= "" then
                                                                                                            if _G and _G.FaceBlox and _G.FaceBlox.remoteEvents and _G.FaceBlox.remoteEvents.CommentPost then
                                                                                                                pcall(function() _G.FaceBlox.remoteEvents.CommentPost:FireServer(postId, commentTextBox.Text) end)
                                                                                                                end
                                                                                                                    commentTextBox.Text = ""
                                                                                                                end
                                                                                                            end)
                                                                                                        end
                                                                                                        
                                                                                                        -- Exportar funciones a _G para que otras partes las llamen
                                                                                                        _G.FaceBlox.functions = _G.FaceBlox.functions or {}
                                                                                                            _G.FaceBlox.functions.createPostFrame = createPostFrame
                                                                                                                _G.FaceBlox.functions.showCommentsSection = showCommentsSection
                                                                                                                    _G.FaceBlox.functions.getMusicTitle = getMusicTitle
                                                                                                                        _G.FaceBlox.state = state
                                                                                                                        
                                                                                                                        print("FaceBlox Cliente - Parte 02 (Posts & Comments) cargada.")


-- FaceBlox_Client_03_PagesAndUIActions
-- Parte 3: loaders (loadFeed, loadDiscoverPage, loadCreatePage, loadSettingsPage),
-- createUserResultFrame, search UI behaviors, music selection UI, report modal, switchView.
-- Usa las funciones de Parte2 y UI de Parte1.

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local gui = playerGui:WaitForChild("FaceBloxGui")
local ui = _G.FaceBlox.ui
local state = _G.FaceBlox.state

-- Helpers
local function createUserResultFrame(userData, parent)
    local resultFrame = Instance.new("Frame")
    resultFrame.Name = "UserResult_" .. tostring(userData.userId)
    resultFrame.Size = UDim2.new(1, 0, 0, 80)
    resultFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    resultFrame.BorderSizePixel = 0
    resultFrame.Parent = parent
    
    local resultCorner = Instance.new("UICorner")
    resultCorner.CornerRadius = UDim.new(0, 10)
    resultCorner.Parent = resultFrame
    
    local userPic = Instance.new("ImageButton")
    userPic.Size = UDim2.new(0, 50, 0, 50)
    userPic.Position = UDim2.new(0, 15, 0, 15)
    userPic.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
    userPic.BorderSizePixel = 0
    userPic.Image = userData.profilePicture or ("https://www.roblox.com/headshot-thumbnail/image?userId=" .. tostring(userData.userId) .. "&width=150&height=150&format=png")
    userPic.Parent = resultFrame
    
    local userPicCorner = Instance.new("UICorner")
    userPicCorner.CornerRadius = UDim.new(0.5, 0)
    userPicCorner.Parent = userPic
    
    local userName = Instance.new("TextLabel")
    userName.Size = UDim2.new(0, 200, 0, 25)
    userName.Position = UDim2.new(0, 80, 0, 10)
    userName.BackgroundTransparency = 1
    userName.Text = userData.displayName
    userName.TextColor3 = Color3.new(1, 1, 1)
    userName.TextScaled = false
    userName.Font = Enum.Font.SourceSansBold
    userName.TextSize = 18
    userName.TextXAlignment = Enum.TextXAlignment.Left
    userName.Parent = resultFrame
    
    -- Verificación
    if _G.FaceBlox and _G.FaceBlox.functions and _G.FaceBlox.functions.getMusicTitle then
        -- usar createVerificationBadgeNextTo definida en Parte2 (accesible si fue exportada)
    end
    -- Intentar llamar verificación (si existe)
    if _G.FaceBlox and _G.FaceBlox.functions and type(_G.FaceBlox.functions.createVerificationBadgeNextTo) == "function" then
        pcall(function() _G.FaceBlox.functions.createVerificationBadgeNextTo(userName, userData.isVerified) end)
        end
            
            local userUsername = Instance.new("TextLabel")
            userUsername.Size = UDim2.new(0, 200, 0, 20)
            userUsername.Position = UDim2.new(0, 80, 0, 32)
            userUsername.BackgroundTransparency = 1
            userUsername.Text = "@" .. (userData.username or "usuario")
            userUsername.TextColor3 = Color3.fromRGB(150, 150, 150)
            userUsername.TextScaled = false
            userUsername.Font = Enum.Font.SourceSans
            userUsername.TextSize = 14
            userUsername.TextXAlignment = Enum.TextXAlignment.Left
            userUsername.Parent = resultFrame
            
            local userStats = Instance.new("TextLabel")
            userStats.Size = UDim2.new(0, 200, 0, 20)
            userStats.Position = UDim2.new(0, 80, 0, 52)
            userStats.BackgroundTransparency = 1
            userStats.Text = (userData.followersCount or 0) .. " seguidores"
            userStats.TextColor3 = Color3.fromRGB(150, 150, 150)
            userStats.TextScaled = false
            userStats.Font = Enum.Font.SourceSans
            userStats.TextSize = 14
            userStats.TextXAlignment = Enum.TextXAlignment.Left
            userStats.Parent = resultFrame
            
            local followButton = Instance.new("TextButton")
            followButton.Size = UDim2.new(0, 80, 0, 30)
            followButton.Position = UDim2.new(1, -140, 0, 25)
            followButton.BackgroundColor3 = Color3.fromRGB(59, 89, 152)
            followButton.BorderSizePixel = 0
            followButton.Text = "Seguir"
            followButton.TextColor3 = Color3.new(1, 1, 1)
            followButton.Font = Enum.Font.SourceSans
            followButton.TextSize = 16
            followButton.Parent = resultFrame
            
            local reportButton = Instance.new("TextButton")
            reportButton.Size = UDim2.new(0, 50, 0, 30)
            reportButton.Position = UDim2.new(1, -50, 0, 25)
            reportButton.BackgroundColor3 = Color3.fromRGB(220, 20, 60)
            reportButton.BorderSizePixel = 0
            reportButton.Text = "⚠"
            reportButton.TextColor3 = Color3.new(1, 1, 1)
            reportButton.Font = Enum.Font.SourceSansBold
            reportButton.TextSize = 18
            reportButton.Parent = resultFrame
            
            followButton.MouseButton1Click:Connect(function()
                followButton.Text = "Siguiendo..."
                followButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
                followButton.Enabled = false
                if _G and _G.FaceBlox and _G.FaceBlox.remoteEvents and _G.FaceBlox.remoteEvents.FollowUser then
                    pcall(function() _G.FaceBlox.remoteEvents.FollowUser:FireServer(userData.userId) end)
                    end
                        wait(0.5)
                        if _G and _G.FaceBlox and type(_G.FaceBlox.functions.loadDiscoverPage) == "function" then
                            _G.FaceBlox.functions.loadDiscoverPage()
                            end
                            end)
                                
                                reportButton.MouseButton1Click:Connect(function()
                                    if _G and _G.FaceBlox and type(_G.FaceBlox.functions.showReportModal) == "function" then
                                        _G.FaceBlox.functions.showReportModal(userData.userId, userData.displayName)
                                        end
                                        end)
                                            
                                            userPic.MouseButton1Click:Connect(function()
                                                if _G and _G.FaceBlox and type(_G.FaceBlox.functions.showUserProfile) == "function" then
                                                    _G.FaceBlox.functions.showUserProfile(tonumber(userData.userId))
                                                    end
                                                    end)
                                                    end
                                                        
                                                        -- showSearchResults: limpia y muestra resultados
                                                        local function showSearchResults(results)
                                                            for _, child in pairs(ui.discoverFrame:GetChildren()) do
                                                                if child.Name:match("^UserResult") or child.Name == "SectionTitle" or child.Name == "NoRecs" or child.Name == "SearchTitle" then
                                                                    child:Destroy()
                                                                end
                                                            end
                                                            
                                                            local searchTitle = Instance.new("TextLabel")
                                                            searchTitle.Name = "SearchTitle"
                                                            searchTitle.Size = UDim2.new(1, 0, 0, 40)
                                                            searchTitle.BackgroundTransparency = 1
                                                            searchTitle.Text = "🔍 Resultados de Búsqueda"
                                                            searchTitle.TextColor3 = Color3.new(1, 1, 1)
                                                            searchTitle.Font = Enum.Font.SourceSansBold
                                                            searchTitle.TextSize = 20
                                                            searchTitle.Parent = ui.discoverFrame
                                                            
                                                            if results and #results > 0 then
                                                                for _, userData in ipairs(results) do
                                                                    createUserResultFrame(userData, ui.discoverFrame)
                                                                end
                                                            else
                                                                local noResults = Instance.new("TextLabel")
                                                                noResults.Name = "NoResults"
                                                                noResults.Size = UDim2.new(1, 0, 0, 60)
                                                                noResults.BackgroundTransparency = 1
                                                                noResults.Text = "No se encontraron usuarios con ese nombre."
                                                                noResults.TextColor3 = Color3.new(1,1,1)
                                                                noResults.Font = Enum.Font.SourceSans
                                                                noResults.TextSize = 16
                                                                noResults.Parent = ui.discoverFrame
                                                            end
                                                            
                                                            ui.discoverFrame.CanvasSize = UDim2.new(0, 0, 0, ui.discoverLayout.AbsoluteContentSize.Y)
                                                        end
                                                        
                                                        -- loadFeed: obtiene feed desde RemoteFunction GetFeed (Parte4 expone remoteFunctions)
                                                        local function loadFeed()
                                                            -- Limpiar
                                                            for _, child in pairs(ui.feedScroll:GetChildren()) do
                                                                if child.Name:match("^PostFrame_") then
                                                                    child:Destroy()
                                                                end
                                                            end
                                                            state.postWidgets = {}
                                                            
                                                            if _G and _G.FaceBlox and _G.FaceBlox.remoteFunctions and _G.FaceBlox.remoteFunctions.GetFeed then
                                                                local ok, feedData = pcall(function() return _G.FaceBlox.remoteFunctions.GetFeed:InvokeServer() end)
                                                                    feedData = ok and feedData or {}
                                                                    if feedData then
                                                                        for _, postData in ipairs(feedData) do
                                                                            local pf = _G.FaceBlox.functions.createPostFrame(postData)
                                                                                pf.Parent = ui.feedScroll
                                                                            end
                                                                        end
                                                                    end
                                                                    
                                                                    ui.feedScroll.CanvasSize = UDim2.new(0, 0, 0, ui.feedLayout.AbsoluteContentSize.Y)
                                                                end
                                                                
                                                                -- loadDiscoverPage: obtener recomendaciones y mostrar
                                                                local function loadDiscoverPage()
                                                                    -- limpiar previos
                                                                    for _, child in pairs(ui.discoverFrame:GetChildren()) do
                                                                        if child.Name:match("^UserResult") or child.Name == "SectionTitle" or child.Name == "NoRecs" or child.Name == "SearchTitle" then
                                                                            child:Destroy()
                                                                        end
                                                                    end
                                                                    
                                                                    if _G and _G.FaceBlox and _G.FaceBlox.remoteFunctions and _G.FaceBlox.remoteFunctions.GetRecommendations then
                                                                        spawn(function()
                                                                            local ok, recs = pcall(function() return _G.FaceBlox.remoteFunctions.GetRecommendations:InvokeServer() end)
                                                                                recs = ok and recs or {}
                                                                                if recs and #recs > 0 then
                                                                                    for i, u in ipairs(recs) do
                                                                                        createUserResultFrame(u, ui.discoverFrame)
                                                                                    end
                                                                                else
                                                                                    local empty = Instance.new("TextLabel")
                                                                                    empty.Name = "NoRecs"
                                                                                    empty.Size = UDim2.new(1, 0, 0, 60)
                                                                                    empty.BackgroundTransparency = 1
                                                                                    empty.Text = "No hay recomendaciones por ahora. Usa la búsqueda para encontrar usuarios."
                                                                                    empty.TextColor3 = Color3.new(1,1,1)
                                                                                    empty.Font = Enum.Font.SourceSans
                                                                                    empty.TextSize = 16
                                                                                    empty.Parent = ui.discoverFrame
                                                                                end
                                                                                ui.discoverFrame.CanvasSize = UDim2.new(0, 0, 0, ui.discoverLayout.AbsoluteContentSize.Y)
                                                                            end)
                                                                        end
                                                                    end
                                                                    
                                                                    -- loadCreatePage: UI de creación -> similar al tuyo
                                                                    local function loadCreatePage()
                                                                        for _, child in pairs(ui.createFrame:GetChildren()) do
                                                                            child:Destroy()
                                                                        end
                                                                        
                                                                        local titleLabel = Instance.new("TextLabel")
                                                                        titleLabel.Size = UDim2.new(1, 0, 0, 40)
                                                                        titleLabel.Position = UDim2.new(0, 0, 0, 0)
                                                                        titleLabel.BackgroundTransparency = 1
                                                                        titleLabel.Text = "Crear Nueva Publicación"
                                                                        titleLabel.TextColor3 = Color3.new(1, 1, 1)
                                                                        titleLabel.TextScaled = true
                                                                        titleLabel.Font = Enum.Font.SourceSansBold
                                                                        titleLabel.Parent = ui.createFrame
                                                                        
                                                                        local postContentFrame = Instance.new("Frame")
                                                                        postContentFrame.Size = UDim2.new(1, 0, 0, 300)
                                                                        postContentFrame.Position = UDim2.new(0, 0, 0, 50)
                                                                        postContentFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
                                                                        postContentFrame.BorderSizePixel = 0
                                                                        postContentFrame.Parent = ui.createFrame
                                                                        
                                                                        local contentFrameCorner = Instance.new("UICorner")
                                                                        contentFrameCorner.CornerRadius = UDim.new(0, 10)
                                                                        contentFrameCorner.Parent = postContentFrame
                                                                        
                                                                        local postTextBox = Instance.new("TextBox")
                                                                        postTextBox.Size = UDim2.new(1, -20, 0, 180)
                                                                        postTextBox.Position = UDim2.new(0, 10, 0, 10)
                                                                        postTextBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
                                                                        postTextBox.BorderSizePixel = 0
                                                                        postTextBox.Text = ""
                                                                        postTextBox.PlaceholderText = "¿Qué está pasando?..."
                                                                        postTextBox.TextColor3 = Color3.new(1, 1, 1)
                                                                        postTextBox.Font = Enum.Font.SourceSans
                                                                        postTextBox.TextSize = 18
                                                                        postTextBox.TextWrapped = true
                                                                        postTextBox.MultiLine = true
                                                                        postTextBox.TextXAlignment = Enum.TextXAlignment.Left
                                                                        postTextBox.TextYAlignment = Enum.TextYAlignment.Top
                                                                        postTextBox.Parent = postContentFrame
                                                                        
                                                                        local textBoxCorner = Instance.new("UICorner")
                                                                        textBoxCorner.CornerRadius = UDim.new(0, 8)
                                                                        textBoxCorner.Parent = postTextBox
                                                                        
                                                                        local charCounter = Instance.new("TextLabel")
                                                                        charCounter.Size = UDim2.new(0, 100, 0, 20)
                                                                        charCounter.Position = UDim2.new(1, -110, 0, 200)
                                                                        charCounter.BackgroundTransparency = 1
                                                                        charCounter.Text = "0/2000"
                                                                        charCounter.TextColor3 = Color3.fromRGB(150, 150, 150)
                                                                        charCounter.TextScaled = true
                                                                        charCounter.Font = Enum.Font.SourceSans
                                                                        charCounter.Parent = postContentFrame
                                                                        
                                                                        postTextBox:GetPropertyChangedSignal("Text"):Connect(function()
                                                                            local length = string.len(postTextBox.Text)
                                                                            charCounter.Text = length .. "/2000"
                                                                            charCounter.TextColor3 = length > 2000 and Color3.fromRGB(255, 100, 100) or Color3.fromRGB(150, 150, 150)
                                                                        end)
                                                                        
                                                                        local buttonsFrame = Instance.new("Frame")
                                                                        buttonsFrame.Size = UDim2.new(1, -20, 0, 50)
                                                                        buttonsFrame.Position = UDim2.new(0, 10, 0, 230)
                                                                        buttonsFrame.BackgroundTransparency = 1
                                                                        buttonsFrame.Parent = postContentFrame
                                                                        
                                                                        local musicButton = Instance.new("TextButton")
                                                                        musicButton.Size = UDim2.new(0, 180, 0, 40)
                                                                        musicButton.Position = UDim2.new(0, 0, 0, 5)
                                                                        musicButton.BackgroundColor3 = Color3.fromRGB(156, 39, 176)
                                                                        musicButton.BorderSizePixel = 0
                                                                        musicButton.Text = state.selectedMusicId ~= "" and "🎵 " .. (_G.FaceBlox.functions.getMusicTitle and _G.FaceBlox.functions.getMusicTitle(state.selectedMusicId) or "") or "🎵 Agregar Música"
                                                                            musicButton.TextColor3 = Color3.new(1, 1, 1)
                                                                            musicButton.TextScaled = true
                                                                            musicButton.Font = Enum.Font.SourceSans
                                                                            musicButton.Parent = buttonsFrame
                                                                            
                                                                            local musicCorner = Instance.new("UICorner")
                                                                            musicCorner.CornerRadius = UDim.new(0, 8)
                                                                            musicCorner.Parent = musicButton
                                                                            
                                                                            local cancelButton = Instance.new("TextButton")
                                                                            cancelButton.Size = UDim2.new(0, 100, 0, 40)
                                                                            cancelButton.Position = UDim2.new(1, -220, 0, 5)
                                                                            cancelButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
                                                                            cancelButton.BorderSizePixel = 0
                                                                            cancelButton.Text = "Cancelar"
                                                                            cancelButton.TextColor3 = Color3.new(1, 1, 1)
                                                                            cancelButton.TextScaled = true
                                                                            cancelButton.Font = Enum.Font.SourceSans
                                                                            cancelButton.Parent = buttonsFrame
                                                                            
                                                                            local cancelCorner = Instance.new("UICorner")
                                                                            cancelCorner.CornerRadius = UDim.new(0, 8)
                                                                            cancelCorner.Parent = cancelButton
                                                                            
                                                                            local publishButton = Instance.new("TextButton")
                                                                            publishButton.Size = UDim2.new(0, 100, 0, 40)
                                                                            publishButton.Position = UDim2.new(1, -110, 0, 5)
                                                                            publishButton.BackgroundColor3 = Color3.fromRGB(59, 89, 152)
                                                                            publishButton.BorderSizePixel = 0
                                                                            publishButton.Text = "Publicar"
                                                                            publishButton.TextColor3 = Color3.new(1, 1, 1)
                                                                            publishButton.TextScaled = true
                                                                            publishButton.Font = Enum.Font.SourceSansBold
                                                                            publishButton.Parent = buttonsFrame
                                                                            
                                                                            local publishCorner = Instance.new("UICorner")
                                                                            publishCorner.CornerRadius = UDim.new(0, 8)
                                                                            publishCorner.Parent = publishButton
                                                                            
                                                                            musicButton.MouseButton1Click:Connect(function()
                                                                                if _G and _G.FaceBlox and type(_G.FaceBlox.functions.showMusicSelection) == "function" then
                                                                                    _G.FaceBlox.functions.showMusicSelection()
                                                                                    end
                                                                                    end)
                                                                                        
                                                                                        cancelButton.MouseButton1Click:Connect(function()
                                                                                            postTextBox.Text = ""
                                                                                            state.selectedMusicId = ""
                                                                                            if _G and _G.FaceBlox and type(_G.FaceBlox.functions.switchView) == "function" then
                                                                                                _G.FaceBlox.functions.switchView("feed")
                                                                                                end
                                                                                                end)
                                                                                                    
                                                                                                    publishButton.MouseButton1Click:Connect(function()
                                                                                                        local text = postTextBox.Text
                                                                                                        if text ~= "" and string.len(text) <= 2000 then
                                                                                                            if _G and _G.FaceBlox and _G.FaceBlox.remoteEvents and _G.FaceBlox.remoteEvents.CreatePost then
                                                                                                                pcall(function() _G.FaceBlox.remoteEvents.CreatePost:FireServer(text, "", state.selectedMusicId) end)
                                                                                                                end
                                                                                                                    postTextBox.Text = ""
                                                                                                                    state.selectedMusicId = ""
                                                                                                                    if _G and _G.FaceBlox and type(_G.FaceBlox.functions.switchView) == "function" then
                                                                                                                        _G.FaceBlox.functions.switchView("feed")
                                                                                                                        end
                                                                                                                        end
                                                                                                                        end)
                                                                                                                        end
                                                                                                                            
                                                                                                                            -- loadSettingsPage (usa remoteFunctions.GetProfile e GetUserPosts)
                                                                                                                            local function loadSettingsPage(userId)
                                                                                                                                for _, child in pairs(ui.settingsFrame:GetChildren()) do
                                                                                                                                    if child:IsA("UIListLayout") == false then
                                                                                                                                        child:Destroy()
                                                                                                                                    end
                                                                                                                                end
                                                                                                                                
                                                                                                                                local loader = Instance.new("TextLabel")
                                                                                                                                loader.Size = UDim2.new(1, 0, 0, 40)
                                                                                                                                loader.BackgroundTransparency = 1
                                                                                                                                loader.Text = "Cargando perfil..."
                                                                                                                                loader.TextColor3 = Color3.new(1,1,1)
                                                                                                                                loader.Font = Enum.Font.SourceSansBold
                                                                                                                                loader.TextSize = 18
                                                                                                                                loader.Parent = ui.settingsFrame
                                                                                                                                
                                                                                                                                spawn(function()
                                                                                                                                    if _G and _G.FaceBlox and _G.FaceBlox.remoteFunctions and _G.FaceBlox.remoteFunctions.GetProfile then
                                                                                                                                        local ok, profileData = pcall(function() return _G.FaceBlox.remoteFunctions.GetProfile:InvokeServer(userId) end)
                                                                                                                                            profileData = ok and profileData or nil
                                                                                                                                            if not profileData then
                                                                                                                                                loader.Text = "Usuario no encontrado"
                                                                                                                                                return
                                                                                                                                            end
                                                                                                                                            
                                                                                                                                            for _, child in pairs(ui.settingsFrame:GetChildren()) do
                                                                                                                                                if child:IsA("UIListLayout") == false then child:Destroy() end
                                                                                                                                            end
                                                                                                                                            
                                                                                                                                            local profileHeader = Instance.new("Frame")
                                                                                                                                            profileHeader.Name = "ProfileHeader"
                                                                                                                                            profileHeader.Size = UDim2.new(1, 0, 0, 200)
                                                                                                                                            profileHeader.BackgroundColor3 = Color3.fromRGB(59, 89, 152)
                                                                                                                                            profileHeader.BorderSizePixel = 0
                                                                                                                                            profileHeader.Parent = ui.settingsFrame
                                                                                                                                            
                                                                                                                                            local headerCorner = Instance.new("UICorner")
                                                                                                                                            headerCorner.CornerRadius = UDim.new(0, 15)
                                                                                                                                            headerCorner.Parent = profileHeader
                                                                                                                                            
                                                                                                                                            local headerGradient2 = Instance.new("UIGradient")
                                                                                                                                            headerGradient2.Color = ColorSequence.new{
                                                                                                                                            ColorSequenceKeypoint.new(0, Color3.fromRGB(59, 89, 152)),
                                                                                                                                            ColorSequenceKeypoint.new(1, Color3.fromRGB(45, 70, 120))
                                                                                                                                            }
                                                                                                                                            headerGradient2.Rotation = 45
                                                                                                                                            headerGradient2.Parent = profileHeader
                                                                                                                                            
                                                                                                                                            local bigProfilePic = Instance.new("ImageLabel")
                                                                                                                                            bigProfilePic.Size = UDim2.new(0, 120, 0, 120)
                                                                                                                                            bigProfilePic.Position = UDim2.new(0, 30, 0, 40)
                                                                                                                                            bigProfilePic.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
                                                                                                                                            bigProfilePic.BorderSizePixel = 0
                                                                                                                                            bigProfilePic.Image = profileData.profilePicture or ("https://www.roblox.com/headshot-thumbnail/image?userId=" .. tostring(userId) .. "&width=150&height=150&format=png")
                                                                                                                                            bigProfilePic.Parent = profileHeader
                                                                                                                                            
                                                                                                                                            local bigPicCorner = Instance.new("UICorner")
                                                                                                                                            bigPicCorner.CornerRadius = UDim.new(0.5, 0)
                                                                                                                                            bigPicCorner.Parent = bigProfilePic
                                                                                                                                            
                                                                                                                                            local nameLabel = Instance.new("TextLabel")
                                                                                                                                            nameLabel.Size = UDim2.new(0, 300, 0, 40)
                                                                                                                                            nameLabel.Position = UDim2.new(0, 170, 0, 40)
                                                                                                                                            nameLabel.BackgroundTransparency = 1
                                                                                                                                            nameLabel.Text = profileData.displayName
                                                                                                                                            nameLabel.TextColor3 = Color3.new(1, 1, 1)
                                                                                                                                            nameLabel.TextScaled = false
                                                                                                                                            nameLabel.Font = Enum.Font.SourceSansBold
                                                                                                                                            nameLabel.TextSize = 22
                                                                                                                                            nameLabel.TextXAlignment = Enum.TextXAlignment.Left
                                                                                                                                            nameLabel.Parent = profileHeader
                                                                                                                                            
                                                                                                                                            -- Verificación en perfil
                                                                                                                                            if _G.FaceBlox and _G.FaceBlox.functions and type(_G.FaceBlox.functions.createVerificationBadgeNextTo) == "function" then
                                                                                                                                                pcall(function() _G.FaceBlox.functions.createVerificationBadgeNextTo(nameLabel, profileData.isVerified or profileData.isAdmin) end)
                                                                                                                                                end
                                                                                                                                                    
                                                                                                                                                    local statsLabel = Instance.new("TextLabel")
                                                                                                                                                    statsLabel.Size = UDim2.new(0, 400, 0, 30)
                                                                                                                                                    statsLabel.Position = UDim2.new(0, 170, 0, 85)
                                                                                                                                                    statsLabel.BackgroundTransparency = 1
                                                                                                                                                    statsLabel.Text = string.format("%d seguidores • %d siguiendo • %d posts",
                                                                                                                                                    profileData.followersCount, profileData.followingCount, profileData.postsCount)
                                                                                                                                                    statsLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
                                                                                                                                                    statsLabel.TextScaled = false
                                                                                                                                                    statsLabel.Font = Enum.Font.SourceSans
                                                                                                                                                    statsLabel.TextSize = 16
                                                                                                                                                    statsLabel.TextXAlignment = Enum.TextXAlignment.Left
                                                                                                                                                    statsLabel.Parent = profileHeader
                                                                                                                                                    
                                                                                                                                                    local bioLabel = Instance.new("TextLabel")
                                                                                                                                                    bioLabel.Size = UDim2.new(0, 400, 0, 25)
                                                                                                                                                    bioLabel.Position = UDim2.new(0, 170, 0, 120)
                                                                                                                                                    bioLabel.BackgroundTransparency = 1
                                                                                                                                                    bioLabel.Text = '"' .. (profileData.bio or "Sin biografía") .. '"'
                                                                                                                                                    bioLabel.TextColor3 = Color3.fromRGB(220, 220, 220)
                                                                                                                                                    bioLabel.TextScaled = false
                                                                                                                                                    bioLabel.Font = Enum.Font.SourceSansItalic
                                                                                                                                                    bioLabel.TextSize = 16
                                                                                                                                                    bioLabel.TextWrapped = true
                                                                                                                                                    bioLabel.TextXAlignment = Enum.TextXAlignment.Left
                                                                                                                                                    bioLabel.Parent = profileHeader
                                                                                                                                                    
                                                                                                                                                    local infoFrame = Instance.new("Frame")
                                                                                                                                                    infoFrame.Name = "Info"
                                                                                                                                                    infoFrame.Size = UDim2.new(1, 0, 0, 100)
                                                                                                                                                    infoFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
                                                                                                                                                    infoFrame.BorderSizePixel = 0
                                                                                                                                                    infoFrame.Parent = ui.settingsFrame
                                                                                                                                                    
                                                                                                                                                    local infoCorner = Instance.new("UICorner")
                                                                                                                                                    infoCorner.CornerRadius = UDim.new(0, 10)
                                                                                                                                                    infoCorner.Parent = infoFrame
                                                                                                                                                    
                                                                                                                                                    local joinDateLabel = Instance.new("TextLabel")
                                                                                                                                                    joinDateLabel.Size = UDim2.new(1, -20, 0, 30)
                                                                                                                                                    joinDateLabel.Position = UDim2.new(0, 10, 0, 10)
                                                                                                                                                    joinDateLabel.BackgroundTransparency = 1
                                                                                                                                                    joinDateLabel.Text = "📅 Se unió el " .. os.date("%d/%m/%Y", profileData.joinDate)
                                                                                                                                                    joinDateLabel.TextColor3 = Color3.new(1, 1, 1)
                                                                                                                                                    joinDateLabel.TextScaled = false
                                                                                                                                                    joinDateLabel.Font = Enum.Font.SourceSans
                                                                                                                                                    joinDateLabel.TextSize = 16
                                                                                                                                                    joinDateLabel.TextXAlignment = Enum.TextXAlignment.Left
                                                                                                                                                    joinDateLabel.Parent = infoFrame
                                                                                                                                                    
                                                                                                                                                    local activityLabel = Instance.new("TextLabel")
                                                                                                                                                    activityLabel.Size = UDim2.new(1, -20, 0, 25)
                                                                                                                                                    activityLabel.Position = UDim2.new(0, 10, 0, 45)
                                                                                                                                                    activityLabel.BackgroundTransparency = 1
                                                                                                                                                    activityLabel.Text = "🎯 Usuario " .. (tostring(userId) == tostring(player.UserId) and "actual" or "visitado")
                                                                                                                                                    activityLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
                                                                                                                                                    activityLabel.TextScaled = false
                                                                                                                                                    activityLabel.Font = Enum.Font.SourceSans
                                                                                                                                                    activityLabel.TextSize = 16
                                                                                                                                                    activityLabel.TextXAlignment = Enum.TextXAlignment.Left
                                                                                                                                                    activityLabel.Parent = infoFrame
                                                                                                                                                    
                                                                                                                                                    -- Cargar posts del usuario
                                                                                                                                                    if _G and _G.FaceBlox and _G.FaceBlox.remoteFunctions and _G.FaceBlox.remoteFunctions.GetUserPosts then
                                                                                                                                                        local ok, userPosts = pcall(function() return _G.FaceBlox.remoteFunctions.GetUserPosts:InvokeServer(userId) end)
                                                                                                                                                            userPosts = ok and userPosts or {}
                                                                                                                                                            for _, postData in ipairs(userPosts) do
                                                                                                                                                                local pf = _G.FaceBlox.functions.createPostFrame(postData)
                                                                                                                                                                    pf.Parent = ui.settingsFrame
                                                                                                                                                                end
                                                                                                                                                            end
                                                                                                                                                            
                                                                                                                                                            ui.settingsFrame.CanvasSize = UDim2.new(0, 0, 0, ui.settingsLayout.AbsoluteContentSize.Y)
                                                                                                                                                        end
                                                                                                                                                    end)
                                                                                                                                                end
                                                                                                                                                
                                                                                                                                                -- showReportModal (copiado de tu original)
                                                                                                                                                local function showReportModal(userId, displayName)
                                                                                                                                                    ui.feedScroll.Visible = false
                                                                                                                                                    ui.discoverFrame.Visible = false
                                                                                                                                                    ui.createFrame.Visible = false
                                                                                                                                                    ui.settingsFrame.Visible = false
                                                                                                                                                    ui.commentsSection.Visible = false
                                                                                                                                                    ui.reportSection.Visible = true
                                                                                                                                                    
                                                                                                                                                    ui.navBar.Visible = false
                                                                                                                                                    ui.headerFrame.Visible = false
                                                                                                                                                    ui.contentFrame.Size = UDim2.new(1, 0, 1, 0)
                                                                                                                                                    ui.contentFrame.Position = UDim2.new(0, 0, 0, 0)
                                                                                                                                                    
                                                                                                                                                    for _, child in pairs(ui.reportSection:GetChildren()) do
                                                                                                                                                        child:Destroy()
                                                                                                                                                    end
                                                                                                                                                    
                                                                                                                                                    local header = Instance.new("Frame")
                                                                                                                                                    header.Size = UDim2.new(1, 0, 0, 60)
                                                                                                                                                    header.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
                                                                                                                                                    header.Parent = ui.reportSection
                                                                                                                                                    
                                                                                                                                                    local title = Instance.new("TextLabel")
                                                                                                                                                    title.Size = UDim2.new(1, -100, 1, 0)
                                                                                                                                                    title.Position = UDim2.new(0, 20, 0, 0)
                                                                                                                                                    title.BackgroundTransparency = 1
                                                                                                                                                    title.Text = "Reportar a " .. displayName
                                                                                                                                                    title.Font = Enum.Font.SourceSansBold
                                                                                                                                                    title.TextSize = 20
                                                                                                                                                    title.TextColor3 = Color3.new(1, 1, 1)
                                                                                                                                                    title.Parent = header
                                                                                                                                                    
                                                                                                                                                    local closeBtn = Instance.new("TextButton")
                                                                                                                                                    closeBtn.Size = UDim2.new(0, 80, 0, 40)
                                                                                                                                                    closeBtn.Position = UDim2.new(1, -90, 0.5, -20)
                                                                                                                                                    closeBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
                                                                                                                                                    closeBtn.Text = "Cerrar"
                                                                                                                                                    closeBtn.Font = Enum.Font.SourceSansBold
                                                                                                                                                    closeBtn.TextColor3 = Color3.new(1,1,1)
                                                                                                                                                    closeBtn.Parent = header
                                                                                                                                                    closeBtn.MouseButton1Click:Connect(function()
                                                                                                                                                        ui.reportSection.Visible = false
                                                                                                                                                        ui.navBar.Visible = true
                                                                                                                                                        ui.headerFrame.Visible = true
                                                                                                                                                        ui.contentFrame.Size = UDim2.new(1, 0, 1, -140)
                                                                                                                                                        ui.contentFrame.Position = UDim2.new(0, 0, 0, 60)
                                                                                                                                                        if _G and _G.FaceBlox and type(_G.FaceBlox.functions.switchView) == "function" then
                                                                                                                                                            _G.FaceBlox.functions.switchView("discover")
                                                                                                                                                            end
                                                                                                                                                            end)
                                                                                                                                                                
                                                                                                                                                                local contentScroll = Instance.new("ScrollingFrame")
                                                                                                                                                                contentScroll.Size = UDim2.new(1, -40, 1, -140)
                                                                                                                                                                contentScroll.Position = UDim2.new(0, 20, 0, 80)
                                                                                                                                                                contentScroll.BackgroundTransparency = 1
                                                                                                                                                                contentScroll.Parent = ui.reportSection
                                                                                                                                                                
                                                                                                                                                                local layout = Instance.new("UIListLayout")
                                                                                                                                                                layout.Padding = UDim.new(0, 15)
                                                                                                                                                                layout.Parent = contentScroll
                                                                                                                                                                
                                                                                                                                                                local reportReasons = {
                                                                                                                                                                "Spam o contenido no deseado",
                                                                                                                                                                "Acoso o bullying",
                                                                                                                                                                "Contenido inapropiado",
                                                                                                                                                                "Suplantación de identidad",
                                                                                                                                                                "Información falsa",
                                                                                                                                                                "Otro motivo"
                                                                                                                                                                }
                                                                                                                                                                
                                                                                                                                                                local selectedReason = ""
                                                                                                                                                                local reasonButtons = {}
                                                                                                                                                                
                                                                                                                                                                for _, reason in ipairs(reportReasons) do
                                                                                                                                                                    local reasonFrame = Instance.new("Frame")
                                                                                                                                                                    reasonFrame.Size = UDim2.new(1, 0, 0, 50)
                                                                                                                                                                    reasonFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
                                                                                                                                                                    reasonFrame.BorderSizePixel = 0
                                                                                                                                                                    reasonFrame.Parent = contentScroll
                                                                                                                                                                    
                                                                                                                                                                    local reasonButton = Instance.new("TextButton")
                                                                                                                                                                    reasonButton.Size = UDim2.new(1, -20, 1, -10)
                                                                                                                                                                    reasonButton.Position = UDim2.new(0, 10, 0, 5)
                                                                                                                                                                    reasonButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
                                                                                                                                                                    reasonButton.BorderSizePixel = 0
                                                                                                                                                                    reasonButton.Text = reason
                                                                                                                                                                    reasonButton.TextColor3 = Color3.new(1, 1, 1)
                                                                                                                                                                    reasonButton.Font = Enum.Font.SourceSans
                                                                                                                                                                    reasonButton.TextSize = 16
                                                                                                                                                                    reasonButton.Parent = reasonFrame
                                                                                                                                                                    
                                                                                                                                                                    reasonButtons[reason] = reasonButton
                                                                                                                                                                    
                                                                                                                                                                    reasonButton.MouseButton1Click:Connect(function()
                                                                                                                                                                        selectedReason = reason
                                                                                                                                                                        for r, btn in pairs(reasonButtons) do
                                                                                                                                                                            if r == reason then
                                                                                                                                                                                btn.BackgroundColor3 = Color3.fromRGB(220, 20, 60)
                                                                                                                                                                            else
                                                                                                                                                                                btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
                                                                                                                                                                            end
                                                                                                                                                                        end
                                                                                                                                                                    end)
                                                                                                                                                                end
                                                                                                                                                                
                                                                                                                                                                local submitFrame = Instance.new("Frame")
                                                                                                                                                                submitFrame.Size = UDim2.new(1, 0, 0, 80)
                                                                                                                                                                submitFrame.Position = UDim2.new(0, 0, 1, -80)
                                                                                                                                                                submitFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
                                                                                                                                                                submitFrame.Parent = ui.reportSection
                                                                                                                                                                
                                                                                                                                                                local submitButton = Instance.new("TextButton")
                                                                                                                                                                submitButton.Size = UDim2.new(0, 200, 0, 50)
                                                                                                                                                                submitButton.Position = UDim2.new(0.5, -100, 0.5, -25)
                                                                                                                                                                submitButton.BackgroundColor3 = Color3.fromRGB(220, 20, 60)
                                                                                                                                                                submitButton.BorderSizePixel = 0
                                                                                                                                                                submitButton.Text = "Enviar Reporte"
                                                                                                                                                                submitButton.TextColor3 = Color3.new(1, 1, 1)
                                                                                                                                                                submitButton.Font = Enum.Font.SourceSansBold
                                                                                                                                                                submitButton.TextSize = 18
                                                                                                                                                                submitButton.Parent = submitFrame
                                                                                                                                                                
                                                                                                                                                                submitButton.MouseButton1Click:Connect(function()
                                                                                                                                                                    if selectedReason ~= "" then
                                                                                                                                                                        if _G and _G.FaceBlox and _G.FaceBlox.remoteEvents and _G.FaceBlox.remoteEvents.ReportUser then
                                                                                                                                                                            pcall(function() _G.FaceBlox.remoteEvents.ReportUser:FireServer(userId, selectedReason) end)
                                                                                                                                                                            end
                                                                                                                                                                                
                                                                                                                                                                                submitButton.Text = "¡Gracias! Los moderadores revisarán el problema"
                                                                                                                                                                                submitButton.BackgroundColor3 = Color3.fromRGB(46, 125, 50)
                                                                                                                                                                                submitButton.Enabled = false
                                                                                                                                                                                
                                                                                                                                                                                wait(3)
                                                                                                                                                                                ui.reportSection.Visible = false
                                                                                                                                                                                ui.navBar.Visible = true
                                                                                                                                                                                ui.headerFrame.Visible = true
                                                                                                                                                                                ui.contentFrame.Size = UDim2.new(1, 0, 1, -140)
                                                                                                                                                                                ui.contentFrame.Position = UDim2.new(0, 0, 0, 60)
                                                                                                                                                                                if _G and _G.FaceBlox and type(_G.FaceBlox.functions.switchView) == "function" then
                                                                                                                                                                                    _G.FaceBlox.functions.switchView("discover")
                                                                                                                                                                                    end
                                                                                                                                                                                    else
                                                                                                                                                                                        submitButton.Text = "Selecciona una razón"
                                                                                                                                                                                        submitButton.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
                                                                                                                                                                                        wait(1)
                                                                                                                                                                                        submitButton.Text = "Enviar Reporte"
                                                                                                                                                                                        submitButton.BackgroundColor3 = Color3.fromRGB(220, 20, 60)
                                                                                                                                                                                    end
                                                                                                                                                                                end)
                                                                                                                                                                            end
                                                                                                                                                                            
                                                                                                                                                                            -- showMusicSelection: muestra pistas (state.availableMusic)
                                                                                                                                                                            local function showMusicSelection()
                                                                                                                                                                                ui.feedScroll.Visible = false
                                                                                                                                                                                ui.discoverFrame.Visible = false
                                                                                                                                                                                ui.createFrame.Visible = false
                                                                                                                                                                                ui.settingsFrame.Visible = false
                                                                                                                                                                                ui.commentsSection.Visible = false
                                                                                                                                                                                ui.musicSection.Visible = true
                                                                                                                                                                                
                                                                                                                                                                                ui.navBar.Visible = false
                                                                                                                                                                                ui.headerFrame.Visible = false
                                                                                                                                                                                ui.contentFrame.Size = UDim2.new(1, 0, 1, 0)
                                                                                                                                                                                ui.contentFrame.Position = UDim2.new(0, 0, 0, 0)
                                                                                                                                                                                
                                                                                                                                                                                for _, child in pairs(ui.musicSection:GetChildren()) do
                                                                                                                                                                                    if child ~= ui.musicLayout then
                                                                                                                                                                                        child:Destroy()
                                                                                                                                                                                    end
                                                                                                                                                                                end
                                                                                                                                                                                
                                                                                                                                                                                local header = Instance.new("Frame")
                                                                                                                                                                                header.Size = UDim2.new(1, 0, 0, 60)
                                                                                                                                                                                header.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
                                                                                                                                                                                header.Parent = ui.musicSection
                                                                                                                                                                                
                                                                                                                                                                                local title = Instance.new("TextLabel")
                                                                                                                                                                                title.Size = UDim2.new(1, -100, 1, 0)
                                                                                                                                                                                title.Position = UDim2.new(0, 20, 0, 0)
                                                                                                                                                                                title.BackgroundTransparency = 1
                                                                                                                                                                                title.Text = "Seleccionar Música"
                                                                                                                                                                                title.Font = Enum.Font.SourceSansBold
                                                                                                                                                                                title.TextSize = 20
                                                                                                                                                                                title.TextColor3 = Color3.new(1, 1, 1)
                                                                                                                                                                                title.Parent = header
                                                                                                                                                                                
                                                                                                                                                                                local backBtn = Instance.new("TextButton")
                                                                                                                                                                                backBtn.Size = UDim2.new(0, 80, 0, 40)
                                                                                                                                                                                backBtn.Position = UDim2.new(1, -90, 0.5, -20)
                                                                                                                                                                                backBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
                                                                                                                                                                                backBtn.Text = "Volver"
                                                                                                                                                                                backBtn.Font = Enum.Font.SourceSansBold
                                                                                                                                                                                backBtn.TextColor3 = Color3.new(1, 1, 1)
                                                                                                                                                                                backBtn.Parent = header
                                                                                                                                                                                backBtn.MouseButton1Click:Connect(function()
                                                                                                                                                                                    ui.musicSection.Visible = false
                                                                                                                                                                                    ui.navBar.Visible = true
                                                                                                                                                                                    ui.headerFrame.Visible = true
                                                                                                                                                                                    ui.contentFrame.Size = UDim2.new(1, 0, 1, -140)
                                                                                                                                                                                    ui.contentFrame.Position = UDim2.new(0, 0, 0, 60)
                                                                                                                                                                                    if _G and _G.FaceBlox and type(_G.FaceBlox.functions.switchView) == "function" then
                                                                                                                                                                                        _G.FaceBlox.functions.switchView("create")
                                                                                                                                                                                        end
                                                                                                                                                                                        end)
                                                                                                                                                                                            
                                                                                                                                                                                            if #state.availableMusic == 0 then
                                                                                                                                                                                                local empty = Instance.new("TextLabel")
                                                                                                                                                                                                empty.Size = UDim2.new(1, 0, 0, 60)
                                                                                                                                                                                                empty.Position = UDim2.new(0, 0, 0, 80)
                                                                                                                                                                                                empty.BackgroundTransparency = 1
                                                                                                                                                                                                empty.Text = "No hay música cargada. Agrega pistas desde el servidor/administrador."
                                                                                                                                                                                                empty.TextColor3 = Color3.new(1,1,1)
                                                                                                                                                                                                empty.Font = Enum.Font.SourceSans
                                                                                                                                                                                                empty.TextSize = 18
                                                                                                                                                                                                empty.TextWrapped = true
                                                                                                                                                                                                empty.Parent = ui.musicSection
                                                                                                                                                                                            else
                                                                                                                                                                                                for _, music in ipairs(state.availableMusic) do
                                                                                                                                                                                                    local musicFrame = Instance.new("Frame")
                                                                                                                                                                                                    musicFrame.Size = UDim2.new(1, 0, 0, 80)
                                                                                                                                                                                                    musicFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
                                                                                                                                                                                                    musicFrame.BorderSizePixel = 0
                                                                                                                                                                                                    musicFrame.Parent = ui.musicSection
                                                                                                                                                                                                    
                                                                                                                                                                                                    local musicFrameCorner = Instance.new("UICorner")
                                                                                                                                                                                                    musicFrameCorner.CornerRadius = UDim.new(0, 10)
                                                                                                                                                                                                    musicFrameCorner.Parent = musicFrame
                                                                                                                                                                                                    
                                                                                                                                                                                                    local musicIcon = Instance.new("TextLabel")
                                                                                                                                                                                                    musicIcon.Size = UDim2.new(0, 60, 0, 60)
                                                                                                                                                                                                    musicIcon.Position = UDim2.new(0, 10, 0, 10)
                                                                                                                                                                                                    musicIcon.BackgroundColor3 = Color3.fromRGB(156, 39, 176)
                                                                                                                                                                                                    musicIcon.BorderSizePixel = 0
                                                                                                                                                                                                    musicIcon.Text = "🎵"
                                                                                                                                                                                                    musicIcon.TextScaled = true
                                                                                                                                                                                                    musicIcon.Font = Enum.Font.SourceSansBold
                                                                                                                                                                                                    musicIcon.TextColor3 = Color3.new(1, 1, 1)
                                                                                                                                                                                                    musicIcon.Parent = musicFrame
                                                                                                                                                                                                    
                                                                                                                                                                                                    local musicName = Instance.new("TextLabel")
                                                                                                                                                                                                    musicName.Size = UDim2.new(0, 300, 0, 30)
                                                                                                                                                                                                    musicName.Position = UDim2.new(0, 80, 0, 15)
                                                                                                                                                                                                    musicName.BackgroundTransparency = 1
                                                                                                                                                                                                    musicName.Text = music.title
                                                                                                                                                                                                    musicName.TextColor3 = Color3.new(1, 1, 1)
                                                                                                                                                                                                    musicName.Font = Enum.Font.SourceSansBold
                                                                                                                                                                                                    musicName.TextSize = 18
                                                                                                                                                                                                    musicName.TextXAlignment = Enum.TextXAlignment.Left
                                                                                                                                                                                                    musicName.Parent = musicFrame
                                                                                                                                                                                                    
                                                                                                                                                                                                    local selectButton = Instance.new("TextButton")
                                                                                                                                                                                                    selectButton.Size = UDim2.new(0, 100, 0, 40)
                                                                                                                                                                                                    selectButton.Position = UDim2.new(1, -110, 0, 20)
                                                                                                                                                                                                    selectButton.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
                                                                                                                                                                                                    selectButton.BorderSizePixel = 0
                                                                                                                                                                                                    selectButton.Text = "Seleccionar"
                                                                                                                                                                                                    selectButton.TextColor3 = Color3.new(1, 1, 1)
                                                                                                                                                                                                    selectButton.Font = Enum.Font.SourceSansBold
                                                                                                                                                                                                    selectButton.TextSize = 16
                                                                                                                                                                                                    selectButton.Parent = musicFrame
                                                                                                                                                                                                    
                                                                                                                                                                                                    selectButton.MouseButton1Click:Connect(function()
                                                                                                                                                                                                        state.selectedMusicId = music.id
                                                                                                                                                                                                        selectButton.Text = "✓ Seleccionado"
                                                                                                                                                                                                        selectButton.BackgroundColor3 = Color3.fromRGB(46, 125, 50)
                                                                                                                                                                                                        wait(1)
                                                                                                                                                                                                        ui.musicSection.Visible = false
                                                                                                                                                                                                        ui.navBar.Visible = true
                                                                                                                                                                                                        ui.headerFrame.Visible = true
                                                                                                                                                                                                        ui.contentFrame.Size = UDim2.new(1, 0, 1, -140)
                                                                                                                                                                                                        ui.contentFrame.Position = UDim2.new(0, 0, 0, 60)
                                                                                                                                                                                                        if _G and _G.FaceBlox and type(_G.FaceBlox.functions.switchView) == "function" then
                                                                                                                                                                                                            _G.FaceBlox.functions.switchView("create")
                                                                                                                                                                                                            end
                                                                                                                                                                                                            end)
                                                                                                                                                                                                            end
                                                                                                                                                                                                            end
                                                                                                                                                                                                                
                                                                                                                                                                                                                ui.musicSection.CanvasSize = UDim2.new(0, 0, 0, ui.musicLayout.AbsoluteContentSize.Y)
                                                                                                                                                                                                            end
                                                                                                                                                                                                            
                                                                                                                                                                                                            -- switchView: controla visibilidad y usa loaders definidos arriba
                                                                                                                                                                                                            local function switchView(view)
                                                                                                                                                                                                                state.currentView = view
                                                                                                                                                                                                                
                                                                                                                                                                                                                ui.feedScroll.Visible = false
                                                                                                                                                                                                                ui.discoverFrame.Visible = false
                                                                                                                                                                                                                ui.createFrame.Visible = false
                                                                                                                                                                                                                ui.settingsFrame.Visible = false
                                                                                                                                                                                                                ui.commentsSection.Visible = false
                                                                                                                                                                                                                ui.musicSection.Visible = false
                                                                                                                                                                                                                
                                                                                                                                                                                                                local isDiscoverView = (view == "discover")
                                                                                                                                                                                                                ui.searchFrame.Visible = isDiscoverView
                                                                                                                                                                                                                ui.logoLabel.Visible = not isDiscoverView
                                                                                                                                                                                                                
                                                                                                                                                                                                                for viewName, button in pairs(ui.navButtonInstances) do
                                                                                                                                                                                                                    button.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
                                                                                                                                                                                                                end
                                                                                                                                                                                                                
                                                                                                                                                                                                                if ui.navButtonInstances[view] then
                                                                                                                                                                                                                    ui.navButtonInstances[view].BackgroundColor3 = Color3.fromRGB(59, 89, 152)
                                                                                                                                                                                                                end
                                                                                                                                                                                                                
                                                                                                                                                                                                                if view == "feed" then
                                                                                                                                                                                                                    ui.feedScroll.Visible = true
                                                                                                                                                                                                                    loadFeed()
                                                                                                                                                                                                                elseif view == "discover" then
                                                                                                                                                                                                                    ui.discoverFrame.Visible = true
                                                                                                                                                                                                                    loadDiscoverPage()
                                                                                                                                                                                                                elseif view == "create" then
                                                                                                                                                                                                                    ui.createFrame.Visible = true
                                                                                                                                                                                                                    loadCreatePage()
                                                                                                                                                                                                                elseif view == "settings" then
                                                                                                                                                                                                                    ui.settingsFrame.Visible = true
                                                                                                                                                                                                                    loadSettingsPage(state.currentProfileId or player.UserId)
                                                                                                                                                                                                                end
                                                                                                                                                                                                            end
                                                                                                                                                                                                            
                                                                                                                                                                                                            -- Exportar a _G.FaceBlox.functions
                                                                                                                                                                                                            _G.FaceBlox.functions = _G.FaceBlox.functions or {}
                                                                                                                                                                                                                _G.FaceBlox.functions.createUserResultFrame = createUserResultFrame
                                                                                                                                                                                                                    _G.FaceBlox.functions.showSearchResults = showSearchResults
                                                                                                                                                                                                                        _G.FaceBlox.functions.loadFeed = loadFeed
                                                                                                                                                                                                                            _G.FaceBlox.functions.loadDiscoverPage = loadDiscoverPage
                                                                                                                                                                                                                                _G.FaceBlox.functions.loadCreatePage = loadCreatePage
                                                                                                                                                                                                                                    _G.FaceBlox.functions.loadSettingsPage = loadSettingsPage
                                                                                                                                                                                                                                        _G.FaceBlox.functions.showReportModal = showReportModal
                                                                                                                                                                                                                                            _G.FaceBlox.functions.showMusicSelection = showMusicSelection
                                                                                                                                                                                                                                                _G.FaceBlox.functions.switchView = switchView
                                                                                                                                                                                                                                                    _G.FaceBlox.functions.showUserProfile = function(uid)
                                                                                                                                                                                                                                                        state.currentProfileId = uid
                                                                                                                                                                                                                                                        switchView("settings")
                                                                                                                                                                                                                                                    end
                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                    -- Conectar nav buttons clicks (fuerza compatibilidad con Parte1)
                                                                                                                                                                                                                                                    for viewName, btn in pairs(ui.navButtonInstances) do
                                                                                                                                                                                                                                                        btn.MouseButton1Click:Connect(function()
                                                                                                                                                                                                                                                            if _G and _G.FaceBlox and type(_G.FaceBlox.functions.switchView) == "function" then
                                                                                                                                                                                                                                                                _G.FaceBlox.functions.switchView(viewName)
                                                                                                                                                                                                                                                                end
                                                                                                                                                                                                                                                                end)
                                                                                                                                                                                                                                                                end
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                    -- Búsqueda: conectar SearchBox aquí para que envíe al server (Parte4)
                                                                                                                                                                                                                                                                    if ui.searchBox then
                                                                                                                                                                                                                                                                        local searchDebounce = false
                                                                                                                                                                                                                                                                        ui.searchBox:GetPropertyChangedSignal("Text"):Connect(function()
                                                                                                                                                                                                                                                                            if state.currentView == "discover" and string.len(ui.searchBox.Text) >= 1 then
                                                                                                                                                                                                                                                                                if not searchDebounce then
                                                                                                                                                                                                                                                                                    searchDebounce = true
                                                                                                                                                                                                                                                                                    ui.searchIndicator.Visible = true
                                                                                                                                                                                                                                                                                    ui.searchIndicator.Text = "🔍 Buscando..."
                                                                                                                                                                                                                                                                                    local tween = TweenService:Create(
                                                                                                                                                                                                                                                                                    ui.searchIndicator,
                                                                                                                                                                                                                                                                                    TweenInfo.new(0.5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true),
                                                                                                                                                                                                                                                                                    {TextTransparency = 0.5}
                                                                                                                                                                                                                                                                                    )
                                                                                                                                                                                                                                                                                    tween:Play()
                                                                                                                                                                                                                                                                                    wait(0.3)
                                                                                                                                                                                                                                                                                    if string.len(ui.searchBox.Text) >= 3 then
                                                                                                                                                                                                                                                                                        if _G and _G.FaceBlox and _G.FaceBlox.remoteFunctions and _G.FaceBlox.remoteFunctions.SearchUsers then
                                                                                                                                                                                                                                                                                            pcall(function() _G.FaceBlox.remoteFunctions.SearchUsers:InvokeServer(ui.searchBox.Text) end)
                                                                                                                                                                                                                                                                                            end
                                                                                                                                                                                                                                                                                            else
                                                                                                                                                                                                                                                                                                ui.searchIndicator.Text = "Escribe al menos 3 caracteres..."
                                                                                                                                                                                                                                                                                                wait(1)
                                                                                                                                                                                                                                                                                                ui.searchIndicator.Visible = false
                                                                                                                                                                                                                                                                                                tween:Cancel()
                                                                                                                                                                                                                                                                                                loadDiscoverPage()
                                                                                                                                                                                                                                                                                            end
                                                                                                                                                                                                                                                                                            searchDebounce = false
                                                                                                                                                                                                                                                                                        end
                                                                                                                                                                                                                                                                                    elseif state.currentView == "discover" and string.len(ui.searchBox.Text) == 0 then
                                                                                                                                                                                                                                                                                        ui.searchIndicator.Visible = false
                                                                                                                                                                                                                                                                                        loadDiscoverPage()
                                                                                                                                                                                                                                                                                    end
                                                                                                                                                                                                                                                                                end)
                                                                                                                                                                                                                                                                            end
                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                            print("FaceBlox Cliente - Parte 03 (Pages & UI Actions) cargada.")



-- FaceBlox_Client_04_RemotesAndInit
-- Parte 4: conectar RemoteEvents y RemoteFunctions desde ReplicatedStorage,
-- listeners en tiempo real (postCreated, postUpdated, commentAdded, followUpdated),
-- linkProfile, búsqueda en tiempo real, y primer switchView("feed").

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Esperar que las otras partes hayan exportado funciones/uis/state
local maxWait = 10
local waited = 0
while (not _G.FaceBlox or not _G.FaceBlox.ui or not _G.FaceBlox.functions) and waited < maxWait do
    waited = waited + 0.1
    wait(0.1)
end
if not _G.FaceBlox or not _G.FaceBlox.ui or not _G.FaceBlox.functions then
    warn("FaceBlox Parte4: No se encontró FaceBlox completo. Asegúrate de que Partes 1-3 estén cargadas.")
    return
end

local ui = _G.FaceBlox.ui
local state = _G.FaceBlox.state

-- Asegurar RemoteEvents/Functions folder
local remoteEventsFolder = ReplicatedStorage:WaitForChild("RemoteEvents")

local function getOrNil(name) return remoteEventsFolder:FindFirstChild(name) end

-- Cliente -> servidor
local createPostEvent    = getOrNil("CreatePost")
local likePostEvent      = getOrNil("LikePost")
local commentPostEvent   = getOrNil("CommentPost")
local followUserEvent    = getOrNil("FollowUser")
local hideCommentEvent   = getOrNil("HideComment")
local reportUserEvent    = getOrNil("ReportUser")
local deleteCommentEvent = getOrNil("DeleteComment")
-- Server -> client
local postCreatedEvent  = getOrNil("PostCreated")
local postUpdatedEvent  = getOrNil("PostUpdated")
local commentAddedEvent = getOrNil("CommentAdded")
local followUpdatedEvent= getOrNil("FollowUpdated")
local linkProfileEvent  = getOrNil("LinkProfile")
local searchResultsEvent = getOrNil("SearchResults")
-- RemoteFunctions
local getFeedFunction = getOrNil("GetFeed")
local getProfileFunction = getOrNil("GetProfile")
local searchUsersFunction = getOrNil("SearchUsers")
local getCommentsFunction = getOrNil("GetComments")
local getUserPostsFunction = getOrNil("GetUserPosts")
local getRecommendationsFunction = getOrNil("GetRecommendations")
local getAdminReportsFunction = getOrNil("GetAdminReports")
local getPlayerAvatarFunction = getOrNil("GetPlayerAvatar")

-- Guardar referencias en _G para que las Partes 2/3 puedan FireServer/Invoke
_G.FaceBlox.remoteEvents = {
CreatePost = createPostEvent,
LikePost = likePostEvent,
CommentPost = commentPostEvent,
FollowUser = followUserEvent,
HideComment = hideCommentEvent,
ReportUser = reportUserEvent,
DeleteComment = deleteCommentEvent
}
_G.FaceBlox.remoteFunctions = {
GetFeed = getFeedFunction,
GetProfile = getProfileFunction,
SearchUsers = searchUsersFunction,
GetComments = getCommentsFunction,
GetUserPosts = getUserPostsFunction,
GetRecommendations = getRecommendationsFunction,
GetAdminReports = getAdminReportsFunction,
GetPlayerAvatar = getPlayerAvatarFunction
}

-- Conectar search results (server -> client)
if searchResultsEvent then
    searchResultsEvent.OnClientEvent:Connect(function(results)
        if _G and _G.FaceBlox and type(_G.FaceBlox.functions.showSearchResults) == "function" then
            _G.FaceBlox.functions.showSearchResults(results)
            end
            end)
            end
                
                -- linkProfileEvent: actualiza avatar y verificación en header
                if linkProfileEvent then
                    linkProfileEvent.OnClientEvent:Connect(function(avatarUrl)
                        local finalAvatarUrl = avatarUrl or ("https://www.roblox.com/headshot-thumbnail/image?userId=" .. player.UserId .. "&width=150&height=150&format=png")
                        pcall(function() ui.profileButton.Image = finalAvatarUrl end)
                            -- Actualizar verificación basada en followers (obteniendo perfil del server)
                            if getProfileFunction then
                                local ok, profileData = pcall(function() return getProfileFunction:InvokeServer(player.UserId) end)
                                    if ok and profileData then
                                        if ui.verifiedBadge then ui.verifiedBadge.Visible = profileData.isVerified or profileData.isAdmin end
                                    end
                                end
                            end)
                        end
                        
                        -- Inicializar avatar del jugador
                        spawn(function()
                            wait(1)
                            local avatarUrl = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. player.UserId .. "&width=150&height=150&format=png"
                            pcall(function() ui.profileButton.Image = avatarUrl end)
                            end)
                                
                                -- profileButton to profile
                                ui.profileButton.MouseButton1Click:Connect(function()
                                    if _G and _G.FaceBlox and type(_G.FaceBlox.functions.showUserProfile) == "function" then
                                        _G.FaceBlox.functions.showUserProfile(player.UserId)
                                        end
                                        end)
                                            
                                            -- linkProfileBtn: pedir avatar al server
                                            ui.linkProfileBtn.MouseButton1Click:Connect(function()
                                                ui.linkProfileBtn.Text = "..."
                                                ui.linkProfileBtn.Enabled = false
                                                
                                                if linkProfileEvent then pcall(function() linkProfileEvent:FireServer() end) end
                                                
                                                wait(1)
                                                ui.linkProfileBtn.Text = "✓"
                                                ui.linkProfileBtn.BackgroundColor3 = Color3.fromRGB(46, 125, 50)
                                                
                                                wait(2)
                                                ui.linkProfileBtn.Text = "🔗"
                                                ui.linkProfileBtn.BackgroundColor3 = Color3.fromRGB(46, 125, 50)
                                                ui.linkProfileBtn.Enabled = true
                                                
                                                if _G and _G.FaceBlox and type(_G.FaceBlox.functions.loadSettingsPage) == "function" then
                                                    _G.FaceBlox.functions.loadSettingsPage(_G.FaceBlox.state.currentProfileId or player.UserId)
                                                    end
                                                    end)
                                                        
                                                        -- Broadcast listeners para updates en tiempo real
                                                        if postCreatedEvent then
                                                            postCreatedEvent.OnClientEvent:Connect(function(postData)
                                                                if ui.feedScroll.Visible then
                                                                    local pf = _G.FaceBlox.functions.createPostFrame(postData)
                                                                        pf.Parent = ui.feedScroll
                                                                        ui.feedScroll.CanvasSize = UDim2.new(0,0,0, ui.feedLayout.AbsoluteContentSize.Y)
                                                                    end
                                                                end)
                                                            end
                                                            
                                                            if postUpdatedEvent then
                                                                postUpdatedEvent.OnClientEvent:Connect(function(postId, likesCount, commentsCount)
                                                                    -- recargar feed para mantener sincronía (te asegura que el administrador y seguidores estén sincronizados)
                                                                    if _G and _G.FaceBlox and type(_G.FaceBlox.functions.loadFeed) == "function" then
                                                                        _G.FaceBlox.functions.loadFeed()
                                                                        end
                                                                        end)
                                                                        end
                                                                            
                                                                            if commentAddedEvent then
                                                                                commentAddedEvent.OnClientEvent:Connect(function(postId, commentData)
                                                                                    -- Si estamos viendo los comentarios de ese post en particular, recargar sección
                                                                                    if ui.commentsSection.Visible and tostring(_G.FaceBlox.state.currentPostId) == tostring(postId) then
                                                                                        if _G and _G.FaceBlox and type(_G.FaceBlox.functions.showCommentsSection) == "function" then
                                                                                            _G.FaceBlox.functions.showCommentsSection(postId)
                                                                                            end
                                                                                            end
                                                                                            end)
                                                                                            end
                                                                                                
                                                                                                if followUpdatedEvent then
                                                                                                    followUpdatedEvent.OnClientEvent:Connect(function(followerId, targetUserId, isFollowing)
                                                                                                        if tostring(targetUserId) == tostring(_G.FaceBlox.state.currentProfileId) and ui.settingsFrame.Visible then
                                                                                                            if _G and _G.FaceBlox and type(_G.FaceBlox.functions.loadSettingsPage) == "function" then
                                                                                                                _G.FaceBlox.functions.loadSettingsPage(_G.FaceBlox.state.currentProfileId)
                                                                                                                end
                                                                                                                end
                                                                                                                    -- sincronizar allUsers/recomendaciones: recargar discover
                                                                                                                    if ui.discoverFrame.Visible and type(_G.FaceBlox.functions.loadDiscoverPage) == "function" then
                                                                                                                        _G.FaceBlox.functions.loadDiscoverPage()
                                                                                                                        end
                                                                                                                        end)
                                                                                                                        end
                                                                                                                            
                                                                                                                            -- Escuchar SearchResults (ya conectado arriba). Además exponer GetPlayerAvatar si es necesario
                                                                                                                            -- Asegurar CanvasSize listeners
                                                                                                                            local feedLayoutObj = ui.feedLayout
                                                                                                                            if feedLayoutObj then
                                                                                                                                feedLayoutObj:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                                                                                                                                    ui.feedScroll.CanvasSize = UDim2.new(0, 0, 0, feedLayoutObj.AbsoluteContentSize.Y)
                                                                                                                                end)
                                                                                                                            end
                                                                                                                            local discoverLayoutObj = ui.discoverLayout
                                                                                                                            if discoverLayoutObj then
                                                                                                                                discoverLayoutObj:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                                                                                                                                    ui.discoverFrame.CanvasSize = UDim2.new(0, 0, 0, discoverLayoutObj.AbsoluteContentSize.Y)
                                                                                                                                end)
                                                                                                                            end
                                                                                                                            local settingsLayoutObj = ui.settingsLayout
                                                                                                                            if settingsLayoutObj then
                                                                                                                                settingsLayoutObj:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                                                                                                                                    ui.settingsFrame.CanvasSize = UDim2.new(0, 0, 0, settingsLayoutObj.AbsoluteContentSize.Y)
                                                                                                                                end)
                                                                                                                            end
                                                                                                                            local commentsLayoutObj = ui.commentsLayout
                                                                                                                            if commentsLayoutObj then
                                                                                                                                commentsLayoutObj:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                                                                                                                                    ui.commentsSection.CanvasSize = UDim2.new(0, 0, 0, commentsLayoutObj.AbsoluteContentSize.Y)
                                                                                                                                end)
                                                                                                                            end
                                                                                                                            
                                                                                                                            -- Finalmente, iniciar vista inicial (feed)
                                                                                                                            if _G and _G.FaceBlox and type(_G.FaceBlox.functions.switchView) == "function" then
                                                                                                                                _G.FaceBlox.functions.switchView("feed")
                                                                                                                                end
                                                                                                                                    
                                                                                                                                    print("FaceBlox Cliente - Parte 04 (Remotes & Init) cargada. Plataforma lista.")
